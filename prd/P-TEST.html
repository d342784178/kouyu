<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语习集 - 测试</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#7c3aed',
                        tertiary: '#059669',
                        success: '#10b981',
                        danger: '#ef4444',
                        info: '#3b82f6',
                        'text-primary': '#1f2937',
                        'text-secondary': '#6b7280',
                        'bg-card': '#ffffff',
                        'bg-secondary': '#f8fafc',
                        'border-light': '#e5e7eb'
                    },
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 2px 8px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 16px rgba(0, 0, 0, 0.1)'
                    },
                    borderRadius: {
                        'card': '16px'
                    }
                }
            }
        }
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .recording-animation {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
        }
        
        .option-selected {
            background-color: #dbeafe;
            border-color: #2563eb;
            color: #2563eb;
        }
        
        .option-correct {
            background-color: #dcfce7;
            border-color: #10b981;
            color: #10b981;
        }
        
        .option-incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-bg-secondary font-sans">
    <!-- 状态栏 -->
    <div id="status-bar" class="bg-white safe-top">
        <div class="flex justify-between items-center px-6 py-2 text-sm font-medium text-gray-900">
            <span>9:41</span>
            <div class="flex items-center space-x-1">
                <i class="fas fa-signal text-xs"></i>
                <i class="fas fa-wifi text-xs"></i>
                <i class="fas fa-battery-three-quarters text-xs"></i>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div id="main-content" class="min-h-screen pb-24">
        <!-- 顶部导航栏 -->
        <header id="top-header" class="bg-white px-6 py-4 shadow-sm">
            <div id="header-content" class="flex items-center justify-between">
                <!-- 返回按钮 -->
                <button id="back-btn" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center">
                    <i class="fas fa-arrow-left text-gray-600 text-sm"></i>
                </button>
                
                <!-- 测试进度 -->
                <div id="progress-container" class="flex items-center space-x-2">
                    <div id="progress-bar-bg" class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-primary rounded-full progress-bar" style="width: 25%"></div>
                    </div>
                    <span id="progress-text" class="text-sm font-medium text-text-primary">1/4</span>
                </div>
                
                <!-- 占位元素保持居中 -->
                <div class="w-10 h-10"></div>
            </div>
        </header>

        <!-- 测试内容区域 -->
        <div id="test-content" class="mx-6 mt-6">
            <!-- 听力题 -->
            <div id="listening-question" class="bg-white rounded-card shadow-card p-6 fade-in">
                <div id="question-header" class="flex items-center mb-4">
                    <div id="question-type-icon" class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-headphones text-blue-600 text-sm"></i>
                    </div>
                    <h2 id="question-type" class="text-lg font-semibold text-text-primary">听力理解</h2>
                </div>
                
                <div id="question-content">
                    <p id="question-text" class="text-base text-text-primary mb-6">请听下面的短语发音，选择正确的英文短语：</p>
                    
                    <!-- 音频播放器 -->
                    <div id="audio-player" class="bg-gray-50 rounded-xl p-4 mb-6">
                        <button id="audio-play-btn" class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto">
                            <i id="audio-play-icon" class="fas fa-play text-white text-xl"></i>
                        </button>
                        <p id="audio-text" class="text-center text-sm text-text-secondary mt-3">点击播放音频</p>
                    </div>
                    
                    <!-- 选项列表 -->
                    <div id="options-list" class="space-y-3">
                        <button id="option-a" class="w-full p-4 border border-gray-200 rounded-xl text-left hover:border-primary transition-colors" data-option="A">
                            <span class="font-semibold text-text-primary">A. </span>
                            <span class="text-text-primary">Could you please...</span>
                        </button>
                        <button id="option-b" class="w-full p-4 border border-gray-200 rounded-xl text-left hover:border-primary transition-colors" data-option="B">
                            <span class="font-semibold text-text-primary">B. </span>
                            <span class="text-text-primary">I'm looking for...</span>
                        </button>
                        <button id="option-c" class="w-full p-4 border border-gray-200 rounded-xl text-left hover:border-primary transition-colors" data-option="C">
                            <span class="font-semibold text-text-primary">C. </span>
                            <span class="text-text-primary">Excuse me, where is...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 发音题 -->
            <div id="pronunciation-question" class="bg-white rounded-card shadow-card p-6 hidden">
                <div id="pronunciation-header" class="flex items-center mb-4">
                    <div id="pronunciation-icon" class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-microphone text-green-600 text-sm"></i>
                    </div>
                    <h2 id="pronunciation-type" class="text-lg font-semibold text-text-primary">发音练习</h2>
                </div>
                
                <div id="pronunciation-content">
                    <p id="pronunciation-text" class="text-base text-text-primary mb-6">请朗读下面的短语，AI将为您评分：</p>
                    
                    <!-- 短语显示 -->
                    <div id="phrase-display" class="bg-gray-50 rounded-xl p-4 mb-6 text-center">
                        <p id="phrase-to-pronounce" class="text-xl font-semibold text-text-primary">Could you please...</p>
                        <p id="phrase-meaning" class="text-sm text-text-secondary mt-2">请问你可以...吗？</p>
                    </div>
                    
                    <!-- 录音控制 -->
                    <div id="recording-controls" class="text-center mb-6">
                        <button id="record-btn" class="w-20 h-20 bg-danger rounded-full flex items-center justify-center mx-auto mb-4">
                            <i id="record-icon" class="fas fa-microphone text-white text-2xl"></i>
                        </button>
                        <p id="record-status" class="text-sm text-text-secondary">点击开始录音</p>
                        <p id="record-timer" class="text-lg font-semibold text-danger mt-2 hidden">00:00</p>
                    </div>
                    
                    <!-- AI反馈区域 -->
                    <div id="ai-feedback" class="bg-blue-50 rounded-xl p-4 hidden">
                        <div id="feedback-header" class="flex items-center mb-3">
                            <i class="fas fa-robot text-blue-600 mr-2"></i>
                            <span class="font-semibold text-blue-800">AI发音反馈</span>
                        </div>
                        <div id="feedback-content">
                            <div id="pronunciation-score" class="text-center mb-4">
                                <span id="score-value" class="text-3xl font-bold text-blue-600">--</span>
                                <span class="text-sm text-blue-800 ml-1">分</span>
                            </div>
                            <div id="feedback-text" class="text-sm text-blue-800 space-y-2">
                                <p id="feedback-item-1">发音清晰，语调自然</p>
                                <p id="feedback-item-2">建议注意重音位置</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 情景选择题 -->
            <div id="scenario-question" class="bg-white rounded-card shadow-card p-6 hidden">
                <div id="scenario-header" class="flex items-center mb-4">
                    <div id="scenario-icon" class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-situation text-purple-600 text-sm"></i>
                    </div>
                    <h2 id="scenario-type" class="text-lg font-semibold text-text-primary">情景选择</h2>
                </div>
                
                <div id="scenario-content">
                    <p id="scenario-text" class="text-base text-text-primary mb-6">请选择最适合以下场景的短语：</p>
                    
                    <!-- 场景描述 -->
                    <div id="scenario-description" class="bg-orange-50 rounded-xl p-4 mb-6">
                        <div id="scenario-title" class="flex items-center mb-2">
                            <i class="fas fa-map-marker-alt text-orange-600 mr-2"></i>
                            <span class="font-semibold text-orange-800">场景：餐厅点餐</span>
                        </div>
                        <p id="scenario-detail" class="text-sm text-orange-700">你在餐厅想要点餐，但服务员还没有过来，你应该说什么？</p>
                    </div>
                    
                    <!-- 选项列表 -->
                    <div id="scenario-options" class="space-y-3">
                        <button id="scenario-option-a" class="w-full p-4 border border-gray-200 rounded-xl text-left hover:border-primary transition-colors" data-option="A">
                            <span class="font-semibold text-text-primary">A. </span>
                            <span class="text-text-primary">Could you please take my order?</span>
                            <div class="text-sm text-text-secondary mt-1">请问可以为我点餐吗？</div>
                        </button>
                        <button id="scenario-option-b" class="w-full p-4 border border-gray-200 rounded-xl text-left hover:border-primary transition-colors" data-option="B">
                            <span class="font-semibold text-text-primary">B. </span>
                            <span class="text-text-primary">I'm looking for a menu.</span>
                            <div class="text-sm text-text-secondary mt-1">我在找菜单。</div>
                        </button>
                        <button id="scenario-option-c" class="w-full p-4 border border-gray-200 rounded-xl text-left hover:border-primary transition-colors" data-option="C">
                            <span class="font-semibold text-text-primary">C. </span>
                            <span class="text-text-primary">Excuse me, where is the bathroom?</span>
                            <div class="text-sm text-text-secondary mt-1">不好意思，洗手间在哪里？</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 测试结果页 -->
            <div id="test-result" class="bg-white rounded-card shadow-card p-6 hidden">
                <div id="result-header" class="text-center mb-6">
                    <div id="result-icon" class="w-16 h-16 bg-success rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-white text-2xl"></i>
                    </div>
                    <h2 id="result-title" class="text-xl font-bold text-text-primary mb-2">测试完成！</h2>
                    <p id="result-subtitle" class="text-sm text-text-secondary">恭喜你完成了本次测试</p>
                </div>
                
                <!-- 测试成绩 -->
                <div id="result-content" class="text-center mb-6">
                    <div id="score-container" class="bg-gray-50 rounded-xl p-6 mb-4">
                        <div id="final-score" class="text-4xl font-bold text-primary mb-2">85分</div>
                        <div id="score-percentage" class="text-lg font-semibold text-text-primary mb-2">正确率 85%</div>
                        <div id="mastery-status" class="text-sm text-success font-medium">已掌握</div>
                    </div>
                    
                    <!-- 详细统计 -->
                    <div id="detailed-stats" class="grid grid-cols-3 gap-4">
                        <div id="stat-listening" class="text-center">
                            <div class="text-lg font-bold text-blue-600">1/1</div>
                            <div class="text-xs text-text-secondary">听力</div>
                        </div>
                        <div id="stat-pronunciation" class="text-center">
                            <div class="text-lg font-bold text-green-600">0.8/1</div>
                            <div class="text-xs text-text-secondary">发音</div>
                        </div>
                        <div id="stat-scenario" class="text-center">
                            <div class="text-lg font-bold text-purple-600">1/1</div>
                            <div class="text-xs text-text-secondary">情景</div>
                        </div>
                    </div>
                </div>
                
                <!-- 建议 -->
                <div id="suggestions" class="bg-blue-50 rounded-xl p-4 mb-6">
                    <h3 id="suggestions-title" class="font-semibold text-blue-800 mb-3">学习建议</h3>
                    <ul id="suggestions-list" class="text-sm text-blue-700 space-y-1">
                        <li>• 发音清晰，继续保持</li>
                        <li>• 建议多练习短语的语调变化</li>
                        <li>• 可以尝试更多场景对话练习</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部操作按钮 -->
    <div id="bottom-actions" class="fixed bottom-0 left-0 right-0 bg-white border-t border-border-light p-6 safe-bottom">
        <button id="next-btn" class="w-full py-4 bg-primary text-white rounded-xl font-semibold text-lg disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
            下一题
        </button>
        <button id="submit-btn" class="w-full py-4 bg-success text-white rounded-xl font-semibold text-lg hidden">
            查看结果
        </button>
        <button id="finish-btn" class="w-full py-4 bg-primary text-white rounded-xl font-semibold text-lg hidden">
            完成测试
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 解析URL参数
            function getUrlParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const urlParams = new URLSearchParams(queryString);
                
                for(const [key, value] of urlParams.entries()) {
                    params[key] = value;
                }
                return params;
            }

            // 获取短语ID参数
            const params = getUrlParams();
            const phraseId = params.phraseId || 'default';

            // 测试数据
            const testData = {
                currentQuestion: 0,
                totalQuestions: 3,
                answers: [],
                scores: {
                    listening: 0,
                    pronunciation: 0,
                    scenario: 0
                },
                questions: [
                    {
                        type: 'listening',
                        correctAnswer: 'A',
                        answered: false
                    },
                    {
                        type: 'pronunciation',
                        score: 0,
                        answered: false
                    },
                    {
                        type: 'scenario',
                        correctAnswer: 'A',
                        answered: false
                    }
                ]
            };

            // 页面元素
            const backBtn = document.querySelector('#back-btn');
            const progressBar = document.querySelector('#progress-bar');
            const progressText = document.querySelector('#progress-text');
            const nextBtn = document.querySelector('#next-btn');
            const submitBtn = document.querySelector('#submit-btn');
            const finishBtn = document.querySelector('#finish-btn');

            // 返回按钮
            backBtn.addEventListener('click', function() {
                window.location.href = 'P-PHRASE_DETAIL.html';
            });

            // 更新进度条
            function updateProgress() {
                const progress = ((testData.currentQuestion + 1) / testData.totalQuestions) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `${testData.currentQuestion + 1}/${testData.totalQuestions}`;
            }

            // 显示指定问题
            function showQuestion(index) {
                // 隐藏所有问题
                document.querySelector('#listening-question').classList.add('hidden');
                document.querySelector('#pronunciation-question').classList.add('hidden');
                document.querySelector('#scenario-question').classList.add('hidden');
                document.querySelector('#test-result').classList.add('hidden');

                // 显示当前问题
                const question = testData.questions[index];
                switch(question.type) {
                    case 'listening':
                        document.querySelector('#listening-question').classList.remove('hidden');
                        break;
                    case 'pronunciation':
                        document.querySelector('#pronunciation-question').classList.remove('hidden');
                        break;
                    case 'scenario':
                        document.querySelector('#scenario-question').classList.remove('hidden');
                        break;
                }

                updateProgress();
                updateButtons();
            }

            // 更新按钮状态
            function updateButtons() {
                const currentQuestion = testData.questions[testData.currentQuestion];
                
                if (testData.currentQuestion === testData.totalQuestions - 1) {
                    // 最后一题
                    nextBtn.classList.add('hidden');
                    submitBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    submitBtn.classList.add('hidden');
                }

                // 检查当前问题是否已回答
                if (currentQuestion.type === 'listening' && currentQuestion.answered) {
                    nextBtn.disabled = false;
                } else if (currentQuestion.type === 'pronunciation' && currentQuestion.answered) {
                    nextBtn.disabled = false;
                } else if (currentQuestion.type === 'scenario' && currentQuestion.answered) {
                    nextBtn.disabled = false;
                } else {
                    nextBtn.disabled = true;
                }
            }

            // 听力题处理
            const audioPlayBtn = document.querySelector('#audio-play-btn');
            const audioPlayIcon = document.querySelector('#audio-play-icon');
            const audioText = document.querySelector('#audio-text');
            const listeningOptions = document.querySelectorAll('#options-list button');

            audioPlayBtn.addEventListener('click', function() {
                console.log('播放音频');
                audioPlayIcon.classList.remove('fa-play');
                audioPlayIcon.classList.add('fa-pause');
                audioText.textContent = '正在播放...';
                
                setTimeout(() => {
                    audioPlayIcon.classList.remove('fa-pause');
                    audioPlayIcon.classList.add('fa-play');
                    audioText.textContent = '点击重新播放';
                }, 3000);
            });

            listeningOptions.forEach(option => {
                option.addEventListener('click', function() {
                    if (testData.questions[0].answered) return;
                    
                    const selectedOption = this.dataset.option;
                    const isCorrect = selectedOption === testData.questions[0].correctAnswer;
                    
                    // 标记所有选项
                    listeningOptions.forEach(opt => {
                        opt.disabled = true;
                        if (opt.dataset.option === testData.questions[0].correctAnswer) {
                            opt.classList.add('option-correct');
                        } else if (opt.dataset.option === selectedOption && !isCorrect) {
                            opt.classList.add('option-incorrect');
                        }
                    });
                    
                    // 记录答案
                    testData.questions[0].answered = true;
                    testData.questions[0].userAnswer = selectedOption;
                    testData.scores.listening = isCorrect ? 1 : 0;
                    
                    updateButtons();
                });
            });

            // 发音题处理
            const recordBtn = document.querySelector('#record-btn');
            const recordIcon = document.querySelector('#record-icon');
            const recordStatus = document.querySelector('#record-status');
            const recordTimer = document.querySelector('#record-timer');
            const aiFeedback = document.querySelector('#ai-feedback');
            const scoreValue = document.querySelector('#score-value');

            let isRecording = false;
            let recordingTimer = null;
            let recordingSeconds = 0;

            recordBtn.addEventListener('click', function() {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            });

            function startRecording() {
                console.log('开始录音');
                isRecording = true;
                recordingSeconds = 0;
                
                recordBtn.classList.add('recording-animation');
                recordIcon.classList.remove('fa-microphone');
                recordIcon.classList.add('fa-stop');
                recordStatus.textContent = '正在录音...';
                recordTimer.classList.remove('hidden');
                
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    recordTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            function stopRecording() {
                console.log('停止录音');
                isRecording = false;
                
                recordBtn.classList.remove('recording-animation');
                recordIcon.classList.remove('fa-stop');
                recordIcon.classList.add('fa-microphone');
                recordStatus.textContent = '录音完成';
                recordTimer.classList.add('hidden');
                
                clearInterval(recordingTimer);
                
                // 模拟AI评分
                setTimeout(() => {
                    showAIFeedback();
                }, 1000);
            }

            function showAIFeedback() {
                const score = Math.floor(Math.random() * 20) + 80; // 80-99分
                testData.questions[1].answered = true;
                testData.questions[1].score = score / 100;
                testData.scores.pronunciation = score / 100;
                
                scoreValue.textContent = score;
                aiFeedback.classList.remove('hidden');
                updateButtons();
            }

            // 情景题处理
            const scenarioOptions = document.querySelectorAll('#scenario-options button');

            scenarioOptions.forEach(option => {
                option.addEventListener('click', function() {
                    if (testData.questions[2].answered) return;
                    
                    const selectedOption = this.dataset.option;
                    const isCorrect = selectedOption === testData.questions[2].correctAnswer;
                    
                    // 标记所有选项
                    scenarioOptions.forEach(opt => {
                        opt.disabled = true;
                        if (opt.dataset.option === testData.questions[2].correctAnswer) {
                            opt.classList.add('option-correct');
                        } else if (opt.dataset.option === selectedOption && !isCorrect) {
                            opt.classList.add('option-incorrect');
                        }
                    });
                    
                    // 记录答案
                    testData.questions[2].answered = true;
                    testData.questions[2].userAnswer = selectedOption;
                    testData.scores.scenario = isCorrect ? 1 : 0;
                    
                    updateButtons();
                });
            });

            // 下一题按钮
            nextBtn.addEventListener('click', function() {
                if (testData.currentQuestion < testData.totalQuestions - 1) {
                    testData.currentQuestion++;
                    showQuestion(testData.currentQuestion);
                }
            });

            // 提交按钮
            submitBtn.addEventListener('click', function() {
                showTestResult();
            });

            // 显示测试结果
            function showTestResult() {
                // 隐藏所有问题
                document.querySelector('#listening-question').classList.add('hidden');
                document.querySelector('#pronunciation-question').classList.add('hidden');
                document.querySelector('#scenario-question').classList.add('hidden');
                
                // 显示结果
                document.querySelector('#test-result').classList.remove('hidden');
                
                // 计算总分
                const totalScore = (testData.scores.listening + testData.scores.pronunciation + testData.scores.scenario) / 3 * 100;
                const percentage = Math.round(totalScore);
                const isMastered = percentage >= 80;
                
                // 更新结果显示
                document.querySelector('#final-score').textContent = Math.round(totalScore);
                document.querySelector('#score-percentage').textContent = `正确率 ${percentage}%`;
                document.querySelector('#mastery-status').textContent = isMastered ? '已掌握' : '需要复习';
                document.querySelector('#mastery-status').className = isMastered ? 'text-sm text-success font-medium' : 'text-sm text-orange-600 font-medium';
                
                // 更新统计
                document.querySelector('#stat-listening .text-lg').textContent = `${testData.scores.listening}/1`;
                document.querySelector('#stat-pronunciation .text-lg').textContent = `${testData.scores.pronunciation.toFixed(1)}/1`;
                document.querySelector('#stat-scenario .text-lg').textContent = `${testData.scores.scenario}/1`;
                
                // 更新按钮
                submitBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            }

            // 完成测试按钮
            finishBtn.addEventListener('click', function() {
                // 这里可以保存测试结果到服务器
                console.log('测试完成，保存结果');
                window.location.href = 'P-PHRASE_DETAIL.html';
            });

            // 初始化
            showQuestion(0);
        });
    </script>
</body>
</html>