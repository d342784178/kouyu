import { useState, useRef, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  ArrowLeft,
  Mic,
  MicOff,
  Send,
  Volume2,
  VolumeX,
  Loader2,
  MessageSquare,
  Trophy,
  Target,
  ChevronRight,
  Star,
  Zap,
  CheckCircle,
  RotateCcw,
} from 'lucide-react';
import { Scene, TestResult } from '../types';

// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type TestStatus = 'idle' | 'analyzing' | 'role-selection' | 'initializing' | 'active' | 'completed';
type Difficulty = 'easy' | 'medium' | 'hard';

interface Role {
  id: string;
  name: string;
  description: string;
  emoji: string;
}

interface AnalysisResult {
  sceneType: string;
  sceneDescription: string;
  aiRole: Role;
  userRoles: Role[];
  dialogueGoal: string;
  suggestedTopics: string[];
}

interface Message {
  id: string;
  role: 'ai' | 'user';
  text: string;
  timestamp: number;
}

interface PerformanceAnalysis {
  score: number;
  fluency: number;
  vocabulary: number;
  accuracy: number;
  summary: string;
  strengths: string[];
  suggestions: string[];
}

interface OpenTestDialogProps {
  scene: Scene;
  testContext: string;
  onFinish: (result: TestResult) => void;
  onBack: () => void;
}

// â”€â”€â”€ Mock Scene Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface SceneMockConfig {
  analysisResult: AnalysisResult;
  initialMessage: string;
  aiResponses: string[];
}

const SCENE_MOCK_DATA: Record<string, SceneMockConfig> = {
  s1: {
    analysisResult: {
      sceneType: 'ç¤¾äº¤ä¼šé¢',
      sceneDescription: 'ä½ åœ¨ä¸€å®¶å’–å•¡å…å¶é‡äº†ä¸€ä½å¤–å›½æœ‹å‹ï¼Œè¿™æ˜¯ç»ƒä¹ è‹±è¯­è‡ªæˆ‘ä»‹ç»çš„ç»ä½³æœºä¼šï¼',
      aiRole: { id: 'alex', name: 'Alex', description: 'æ¥è‡ªç¾å›½çš„æ´»æ³¼å¤–å›½äººï¼Œä¸»åŠ¨ä¸ä½ æ­è¯', emoji: 'ğŸ‡ºğŸ‡¸' },
      userRoles: [
        { id: 'self', name: 'ä½ è‡ªå·±', description: 'ç”¨è‹±è¯­è‡ªç„¶åœ°ä»‹ç»è‡ªå·±', emoji: 'ğŸ™‹' },
      ],
      dialogueGoal: 'å®Œæˆè‡ªæˆ‘ä»‹ç»ï¼šåˆ†äº«ä½ çš„åå­—ã€æ¥è‡ªå“ªé‡Œï¼Œä»¥åŠè‡³å°‘ä¸€ä¸ªä¸ªäººå…´è¶£æˆ–ä¿¡æ¯',
      suggestedTopics: ['ä½ çš„åå­—', 'æ¥è‡ªå“ªä¸ªåŸå¸‚', 'èŒä¸šæˆ–å­¦ä¸š', 'å…´è¶£çˆ±å¥½'],
    },
    initialMessage: "Hi there! I noticed you sitting here alone â€” mind if I join you? I'm Alex, by the way! What's your name?",
    aiResponses: [
      "Oh, that's a great name! Where are you from originally? I'm from San Francisco myself.",
      "Wonderful! I've always wanted to visit there. So what do you do â€” are you working or still studying?",
      "That sounds really interesting! Do you have any hobbies or things you enjoy doing in your free time?",
      "It's been so wonderful chatting with you! Your English is really impressive, by the way. Hope we can catch up again sometime!",
    ],
  },
  s2: {
    analysisResult: {
      sceneType: 'è´­ç‰©åœºæ™¯',
      sceneDescription: 'AI å°†æ‰®æ¼”è¶…å¸‚åº—å‘˜ï¼Œå¸®åŠ©ä½ ç»ƒä¹ è´­ç‰©å…¨æµç¨‹ï¼šæ‰¾å•†å“ã€è¯¢ä»·ã€ç»“è´¦ç­‰å¸¸ç”¨è¡¨è¾¾ã€‚',
      aiRole: { id: 'staff', name: 'Emmaï¼ˆåº—å‘˜ï¼‰', description: 'çƒ­å¿ƒçš„è¶…å¸‚å·¥ä½œäººå‘˜', emoji: 'ğŸ›’' },
      userRoles: [
        { id: 'customer', name: 'é¡¾å®¢', description: 'ä½ æ­£åœ¨è¶…å¸‚è´­ç‰©ï¼Œéœ€è¦å¯»æ±‚å¸®åŠ©', emoji: 'ğŸ›ï¸' },
      ],
      dialogueGoal: 'å®Œæˆè¶…å¸‚è´­ç‰©æµç¨‹ï¼šè¯¢é—®å•†å“ä½ç½® â†’ äº†è§£ä»·æ ¼ â†’ ç»“è´¦',
      suggestedTopics: ['è¯¢é—®å•†å“ä½ç½®', 'è¯¢é—®ä»·æ ¼', 'æ˜¯å¦æ‰“æŠ˜', 'ç»“è´¦æ–¹å¼'],
    },
    initialMessage: "Hi there! Welcome to FreshMart. Is there anything I can help you find today?",
    aiResponses: [
      "Sure! The milk is in aisle 4, on the right. While you're there, the organic milk is on sale â€” 2 for $5 today!",
      "That bread is $2.49 right now, and it's freshly baked this morning. Would you like to grab one?",
      "Great news â€” we have a buy-two-get-one-free deal on bakery items this week. That's a pretty good deal!",
      "Sounds like you've got a nice haul! We accept cash, cards, and mobile pay. The checkout lines are open right over there. Have a great day!",
    ],
  },
  s3: {
    analysisResult: {
      sceneType: 'é¤å…ç”¨é¤',
      sceneDescription: 'AI å°†æ‰®æ¼”ä¸“ä¸šé¤å…æœåŠ¡å‘˜ï¼Œå¸¦ä½ ä½“éªŒä»å°±åº§åˆ°ç»“è´¦çš„å®Œæ•´è‹±å¼ç”¨é¤æµç¨‹ã€‚',
      aiRole: { id: 'waiter', name: 'Marcoï¼ˆæœåŠ¡å‘˜ï¼‰', description: 'ä¸“ä¸šç¤¼è²Œçš„æ„å¤§åˆ©é¤å…æœåŠ¡å‘˜', emoji: 'ğŸ½ï¸' },
      userRoles: [
        { id: 'diner', name: 'é¡¾å®¢', description: 'ä½ æ¥åˆ°é¤å…äº«ç”¨æ™šé¤', emoji: 'ğŸ§‘â€ğŸ³' },
      ],
      dialogueGoal: 'å®Œæ•´ç‚¹é¤ä½“éªŒï¼šè¯¢é—®èœå• â†’ äº†è§£ç‰¹è‰²èœ â†’ ç‚¹é¤ â†’ ç»“è´¦',
      suggestedTopics: ['è¯¢é—®å½“å¤©ç‰¹è‰²', 'è¯¢é—®æ˜¯å¦å«æŸç§é£Ÿæ', 'è¡¨è¾¾é¥®é£Ÿåå¥½', 'ç»“è´¦'],
    },
    initialMessage: "Good evening! Welcome to Bella Italia. I'm Marco and I'll be serving you tonight. Can I start you off with something to drink, perhaps some sparkling water or a glass of wine?",
    aiResponses: [
      "Excellent choices! Our specials tonight are the grilled salmon with lemon butter and the black truffle pasta. Are you ready to order, or would you like a few more minutes?",
      "Perfect selection! The chicken pasta is our bestseller. Would you like to add a fresh side salad? It pairs really well with it.",
      "Wonderful, I'll put that in right away. Is there anything else I can get for you â€” perhaps some bread to start?",
      "Of course! Here's your itemized bill. We accept all major cards and contactless payments. It's been a pleasure serving you this evening â€” hope to see you again soon!",
    ],
  },
  s4: {
    analysisResult: {
      sceneType: 'æ—…è¡Œé—®è·¯',
      sceneDescription: 'AI å°†æ‰®æ¼”çƒ­å¿ƒçš„å½“åœ°å±…æ°‘ï¼Œå¸®åŠ©æ­£åœ¨è¿·è·¯çš„ä½ æ‰¾åˆ°ç›®çš„åœ°ï¼Œç»ƒä¹ é—®è·¯å’Œç†è§£è·¯çº¿æŒ‡å¼•ã€‚',
      aiRole: { id: 'local', name: 'Sarahï¼ˆå½“åœ°å±…æ°‘ï¼‰', description: 'ç†Ÿæ‚‰å‘¨è¾¹é“è·¯çš„çƒ­å¿ƒå¸‚æ°‘', emoji: 'ğŸ—ºï¸' },
      userRoles: [
        { id: 'tourist', name: 'æ¸¸å®¢', description: 'ä½ æ˜¯åˆåˆ°æ­¤åœ°çš„æ¸¸å®¢ï¼Œæ­£åœ¨è¿·è·¯', emoji: 'ğŸ§³' },
      ],
      dialogueGoal: 'æˆåŠŸé—®åˆ°è·¯çº¿ï¼šç¡®è®¤ç›®çš„åœ°æ–¹å‘ã€æ­¥è¡Œæ—¶é—´å’Œè·¯çº¿æ ‡å¿—',
      suggestedTopics: ['è¯¢é—®ç›®çš„åœ°æ–¹å‘', 'ç¡®è®¤è·¯çº¿ç»†èŠ‚', 'è¯¢é—®æ­¥è¡Œæ—¶é—´', 'ç¡®è®¤è·¯æ ‡'],
    },
    initialMessage: "Hi there! You look a little lost â€” can I help you find somewhere? I know this area really well!",
    aiResponses: [
      "Oh, the train station! That's easy â€” just walk straight down this road for about 3 blocks, then turn right at the big blue building on the corner.",
      "It's roughly a 10-minute walk from here. You'll pass a small park on your left side â€” just keep going straight after that.",
      "You really can't miss it! There's a tall clock tower right at the entrance of the station â€” it's a local landmark.",
      "You're so welcome! Have a wonderful trip. If you ever need anything else while you're in town, don't hesitate to ask!",
    ],
  },
  s5: {
    analysisResult: {
      sceneType: 'é…’åº—å…¥ä½',
      sceneDescription: 'AI å°†æ‰®æ¼”ä¸“ä¸šé…’åº—å‰å°ï¼Œå¸®ä½ ç»ƒä¹ åŠç†å…¥ä½æ‰‹ç»­çš„å®Œæ•´æµç¨‹ã€‚',
      aiRole: { id: 'receptionist', name: 'Claireï¼ˆå‰å°ï¼‰', description: 'ä¸“ä¸šçƒ­æƒ…çš„é…’åº—å‰å°å·¥ä½œäººå‘˜', emoji: 'ğŸ¨' },
      userRoles: [
        { id: 'guest', name: 'ä½å®¢', description: 'ä½ æ­£åœ¨åŠç†é…’åº—å…¥ä½æ‰‹ç»­', emoji: 'ğŸ§³' },
      ],
      dialogueGoal: 'å®Œæˆå…¥ä½ï¼šç¡®è®¤é¢„è®¢ â†’ æä¾›è¯ä»¶ â†’ äº†è§£è®¾æ–½ â†’ æ‹¿åˆ°æˆ¿å¡',
      suggestedTopics: ['ç¡®è®¤é¢„è®¢', 'è¯¢é—®æ—©é¤', 'è¯¢é—®è®¾æ–½å’ŒWiFi', 'ç¡®è®¤é€€æˆ¿æ—¶é—´'],
    },
    initialMessage: "Good evening, welcome to The Grand Hotel! My name is Claire. How can I assist you today?",
    aiResponses: [
      "Of course! Let me look that up for you. Could I see your ID or passport, please? We just need to verify your identity.",
      "Perfect, I have your reservation right here! Breakfast is complimentary and served from 7 to 10 AM in the dining room on the second floor.",
      "We also have a fitness center and rooftop swimming pool, both open 24 hours. The WiFi password for your room is printed on this card.",
      "Here's your key card for room 308 on the third floor â€” the elevators are just to your right. Please let us know if you need anything at all. Enjoy your stay!",
    ],
  },
};

const DEFAULT_MOCK: SceneMockConfig = {
  analysisResult: {
    sceneType: 'è‹±è¯­å¯¹è¯',
    sceneDescription: 'è¿™æ˜¯ä¸€ä¸ªå¼€æ”¾å¼è‹±è¯­å¯¹è¯ç»ƒä¹ ï¼ŒAI å°†æ‰®æ¼”å¯¹è¯æ­æ¡£ä¸ä½ è¿›è¡ŒçœŸå®çš„è‹±è¯­äº¤æµã€‚',
    aiRole: { id: 'partner', name: 'AI ä¼™ä¼´', description: 'ä½ çš„è‹±è¯­å¯¹è¯æ­æ¡£', emoji: 'ğŸ¤–' },
    userRoles: [{ id: 'self', name: 'ä½ è‡ªå·±', description: 'ç”¨è‹±è¯­è‡ªç„¶è¡¨è¾¾', emoji: 'ğŸ™‹' }],
    dialogueGoal: 'å®Œæˆä¸€æ®µè‡ªç„¶æµç•…çš„è‹±è¯­å¯¹è¯ç»ƒä¹ ',
    suggestedTopics: ['æ—¥å¸¸è¯é¢˜', 'å…´è¶£çˆ±å¥½', 'å·¥ä½œå­¦ä¹ ', 'ç”Ÿæ´»åˆ†äº«'],
  },
  initialMessage: "Hi! I'm your AI conversation partner. Let's have a great chat! What would you like to talk about today?",
  aiResponses: [
    "That's really interesting! Could you tell me more about that?",
    "I see! And how did that make you feel?",
    "Wonderful! You're doing great with your English, by the way!",
    "It's been such a pleasure chatting with you today. Your English is really impressive!",
  ],
};

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const delay = (ms: number) => new Promise((r) => setTimeout(r, ms));

const genId = () => Math.random().toString(36).slice(2, 9);

const speak = (text: string): Promise<void> => {
  return new Promise((resolve) => {
    if (!('speechSynthesis' in window)) { resolve(); return; }
    window.speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.lang = 'en-US';
    utt.rate = 0.88;
    utt.pitch = 1.05;
    utt.onend = () => resolve();
    utt.onerror = () => resolve();
    window.speechSynthesis.speak(utt);
  });
};

const stopSpeak = () => {
  if ('speechSynthesis' in window) window.speechSynthesis.cancel();
};

// â”€â”€â”€ Mock API Calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function apiAnalyzeQuestion(sceneId: string): Promise<AnalysisResult> {
  await delay(1800);
  return (SCENE_MOCK_DATA[sceneId] || DEFAULT_MOCK).analysisResult;
}

async function apiInitiateConversation(
  sceneId: string,
  _difficulty: Difficulty
): Promise<string> {
  await delay(1200);
  return (SCENE_MOCK_DATA[sceneId] || DEFAULT_MOCK).initialMessage;
}

async function apiContinueConversation(
  sceneId: string,
  round: number,
  _userMessage: string,
  _difficulty: Difficulty,
  maxRounds: number
): Promise<{ text: string; shouldEnd: boolean }> {
  await delay(900 + Math.random() * 500);
  const responses = (SCENE_MOCK_DATA[sceneId] || DEFAULT_MOCK).aiResponses;
  const idx = Math.min(round - 1, responses.length - 1);
  return {
    text: responses[Math.max(0, idx)],
    shouldEnd: round >= maxRounds,
  };
}

async function apiAnalyzePerformance(
  messages: Message[],
  rounds: number,
  _difficulty: Difficulty
): Promise<PerformanceAnalysis> {
  await delay(2000);
  const userMsgs = messages.filter((m) => m.role === 'user');
  const avgLen = userMsgs.reduce((s, m) => s + m.text.length, 0) / Math.max(1, userMsgs.length);
  const participation = Math.min(rounds / 5, 1);
  const baseScore = Math.round(60 + participation * 25 + Math.min(avgLen / 10, 10));
  const fluency = Math.min(100, baseScore + Math.round(Math.random() * 8 - 2));
  const vocabulary = Math.min(100, baseScore - 5 + Math.round(Math.random() * 10));
  const accuracy = Math.min(100, baseScore + Math.round(Math.random() * 6));

  return {
    score: baseScore,
    fluency,
    vocabulary,
    accuracy,
    summary:
      rounds >= 5
        ? 'å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†å®Œæ•´çš„5è½®å¯¹è¯ï¼Œè¡¨ç°éå¸¸ç§¯æä¸»åŠ¨ã€‚'
        : `ä½ å®Œæˆäº† ${rounds} è½®å¯¹è¯ï¼Œæ•´ä½“è¡¨è¾¾æµç•…è‡ªç„¶ã€‚`,
    strengths: [
      'èƒ½å¤Ÿä¸»åŠ¨å‚ä¸å¯¹è¯ï¼Œäº’åŠ¨ç§¯æ',
      'è¡¨è¾¾æ„æ€æ¸…æ™°ï¼Œå¯¹æ–¹èƒ½å¤Ÿç†è§£',
      'ä½¿ç”¨äº†åœºæ™¯é€‚åˆçš„è¯æ±‡å’Œå¥å‹',
    ],
    suggestions: [
      'å¯ä»¥å°è¯•ä½¿ç”¨æ›´å¤šè¿æ¥è¯è®©è¡¨è¾¾æ›´æµç•…ï¼ˆsuch as: however, moreover...ï¼‰',
      'å¤šç»ƒä¹ å¬åŠ›ï¼Œæå‡å¯¹è‹±è¯­è¯­é€Ÿçš„é€‚åº”èƒ½åŠ›',
    ],
  };
}

// â”€â”€â”€ Difficulty Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const DIFFICULTY_CONFIG: Record<Difficulty, { label: string; desc: string; color: string; bg: string }> = {
  easy: { label: 'å…¥é—¨', desc: 'AIè¯­é€Ÿæ…¢ï¼Œè¯æ±‡ç®€å•', color: 'text-green-700', bg: 'bg-green-50 border-green-200' },
  medium: { label: 'æ ‡å‡†', desc: 'æ­£å¸¸è¯­é€Ÿï¼Œæ—¥å¸¸è¯æ±‡', color: 'text-blue-700', bg: 'bg-blue-50 border-blue-200' },
  hard: { label: 'æŒ‘æˆ˜', desc: 'æ­£å¸¸è¯­é€Ÿï¼Œåœ°é“è¡¨è¾¾', color: 'text-purple-700', bg: 'bg-purple-50 border-purple-200' },
};

// â”€â”€â”€ Main Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function OpenTestDialog({ scene, testContext, onFinish, onBack }: OpenTestDialogProps) {
  const MAX_ROUNDS = 5;

  // â”€â”€ State â”€â”€
  const [status, setStatus] = useState<TestStatus>('idle');
  const [messages, setMessages] = useState<Message[]>([]);
  const [currentRound, setCurrentRound] = useState(0);
  const [isRecording, setIsRecording] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [analysisResult, setAnalysisResult] = useState<AnalysisResult | null>(null);
  const [selectedRole, setSelectedRole] = useState<string>('');
  const [difficulty, setDifficulty] = useState<Difficulty>('medium');
  const [textInput, setTextInput] = useState('');
  const [performance, setPerformance] = useState<PerformanceAnalysis | null>(null);
  const [isAnalyzingPerf, setIsAnalyzingPerf] = useState(false);
  const [voiceEnabled, setVoiceEnabled] = useState(true);

  const recognitionRef = useRef<any>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // â”€â”€ Auto-scroll â”€â”€
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isGenerating]);

  // â”€â”€ Auto-start â”€â”€
  useEffect(() => {
    if (status === 'idle') analyzeQuestion();
  }, []);

  // â”€â”€ Init selected role â”€â”€
  useEffect(() => {
    if (analysisResult?.userRoles?.length) {
      setSelectedRole(analysisResult.userRoles[0].id);
    }
  }, [analysisResult]);

  // â”€â”€â”€ Phase 1: Analyze Question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const analyzeQuestion = useCallback(async () => {
    setStatus('analyzing');
    setError(null);
    try {
      const result = await apiAnalyzeQuestion(scene.id);
      setAnalysisResult(result);
      setStatus('role-selection');
    } catch (e) {
      setError('é¢˜ç›®åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
      setStatus('idle');
    }
  }, [scene.id]);

  // â”€â”€â”€ Phase 2: Confirm Role & Difficulty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const confirmRoleAndDifficulty = useCallback(async () => {
    if (!analysisResult) return;
    setStatus('initializing');
    setError(null);
    try {
      const initMsg = await apiInitiateConversation(scene.id, difficulty);
      const aiMessage: Message = {
        id: genId(),
        role: 'ai',
        text: initMsg,
        timestamp: Date.now(),
      };
      setMessages([aiMessage]);
      setCurrentRound(1);
      setStatus('active');
      // Auto-play AI greeting
      if (voiceEnabled) {
        setIsSpeaking(true);
        await speak(initMsg);
        setIsSpeaking(false);
      }
    } catch (e) {
      setError('åˆå§‹åŒ–å¯¹è¯å¤±è´¥ï¼Œè¯·é‡è¯•');
      setStatus('role-selection');
    }
  }, [analysisResult, scene.id, difficulty, voiceEnabled]);

  // â”€â”€â”€ Phase 3: Generate AI Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const generateAIResponse = useCallback(
    async (round: number, userText: string) => {
      setIsGenerating(true);
      setError(null);
      try {
        const { text, shouldEnd } = await apiContinueConversation(
          scene.id, round, userText, difficulty, MAX_ROUNDS
        );
        const aiMsg: Message = {
          id: genId(),
          role: 'ai',
          text,
          timestamp: Date.now(),
        };
        setMessages((prev) => [...prev, aiMsg]);
        const nextRound = round + 1;
        setCurrentRound(nextRound);

        // Auto-play
        if (voiceEnabled) {
          setIsSpeaking(true);
          await speak(text);
          setIsSpeaking(false);
        }

        // Check if conversation should end
        if (shouldEnd || nextRound > MAX_ROUNDS) {
          await endConversation(nextRound);
        }
      } catch (e) {
        setError('AI ç”Ÿæˆå›å¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        setIsGenerating(false);
      }
    },
    [scene.id, difficulty, voiceEnabled, MAX_ROUNDS]
  );

  // â”€â”€â”€ Send User Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sendMessage = useCallback(
    async (text: string) => {
      if (!text.trim() || isGenerating) return;
      setTextInput('');
      const userMsg: Message = {
        id: genId(),
        role: 'user',
        text: text.trim(),
        timestamp: Date.now(),
      };
      setMessages((prev) => [...prev, userMsg]);
      await generateAIResponse(currentRound, text.trim());
    },
    [isGenerating, currentRound, generateAIResponse]
  );

  // â”€â”€â”€ Voice Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const toggleRecording = useCallback(() => {
    if (isRecording) {
      recognitionRef.current?.stop();
      setIsRecording(false);
      return;
    }
    const hasSR =
      'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    if (!hasSR) {
      setError('æ‚¨çš„æµè§ˆå™¨æš‚ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼ˆå»ºè®®ä½¿ç”¨ Chromeï¼‰');
      return;
    }
    const SR = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition;
    const recognition = new SR();
    recognitionRef.current = recognition;
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onstart = () => {
      setIsRecording(true);
      stopSpeak();
    };
    recognition.onresult = (e: any) => {
      const transcript = e.results[0][0].transcript;
      setIsRecording(false);
      sendMessage(transcript);
    };
    recognition.onerror = () => {
      setIsRecording(false);
      setError('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–ä½¿ç”¨æ–‡å­—è¾“å…¥');
    };
    recognition.onend = () => setIsRecording(false);
    recognition.start();
  }, [isRecording, sendMessage]);

  // â”€â”€â”€ End Conversation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const endConversation = useCallback(async (rounds: number) => {
    setIsAnalyzingPerf(true);
    try {
      const perf = await apiAnalyzePerformance(
        messages.concat(/* latest messages already added */[]),
        rounds,
        difficulty
      );
      setPerformance(perf);
    } catch {
      setPerformance({
        score: 80,
        fluency: 78,
        vocabulary: 82,
        accuracy: 80,
        summary: 'ä½ å®Œæˆäº†å®Œæ•´çš„å¼€æ”¾å¼å¯¹è¯ç»ƒä¹ ï¼',
        strengths: ['ç§¯æå‚ä¸å¯¹è¯', 'è¡¨è¾¾æ¸…æ™°æ˜“æ‡‚'],
        suggestions: ['ç»§ç»­å¤šç»ƒä¹ ï¼ŒåŠ å¼ºå£è¯­æµåˆ©åº¦'],
      });
    } finally {
      setIsAnalyzingPerf(false);
      setStatus('completed');
    }
  }, [messages, difficulty]);

  const handleFinish = () => {
    if (!performance) return;
    onFinish({
      isCorrect: true,
      score: performance.score,
      analysis: performance.summary,
      suggestion: performance.suggestions[0] || 'ç»§ç»­ä¿æŒç»ƒä¹ ï¼',
    });
  };

  // â”€â”€â”€ Render: Analyzing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const renderAnalyzing = () => (
    <div className="flex-1 flex flex-col items-center justify-center px-6">
      <div className="relative mb-8">
        <motion.div
          className="h-24 w-24 rounded-full bg-gradient-to-br from-[#4F7CF0] to-[#7B5FE8] flex items-center justify-center shadow-xl"
          animate={{ scale: [1, 1.08, 1] }}
          transition={{ duration: 1.8, repeat: Infinity, ease: 'easeInOut' }}
        >
          <Zap className="h-12 w-12 text-white" />
        </motion.div>
        {[0, 1, 2].map((i) => (
          <motion.div
            key={i}
            className="absolute inset-0 rounded-full border-2 border-[#4F7CF0]/30"
            style={{ scale: 1 + (i + 1) * 0.25 }}
            animate={{ opacity: [0.6, 0, 0.6], scale: [1 + (i + 1) * 0.25, 1 + (i + 1) * 0.5] }}
            transition={{ duration: 1.8, repeat: Infinity, delay: i * 0.3 }}
          />
        ))}
      </div>

      <h3 className="font-semibold text-gray-800 mb-2 text-center">AI æ­£åœ¨åˆ†æé¢˜ç›®</h3>
      <p className="text-sm text-gray-400 mb-8 text-center leading-relaxed">
        æ­£åœ¨è§£æåœºæ™¯ã€ç”Ÿæˆè§’è‰²å’Œå¯¹è¯ç›®æ ‡...
      </p>

      <div className="flex items-center gap-2">
        {[0, 0.2, 0.4].map((d, i) => (
          <motion.div
            key={i}
            className="h-2.5 w-2.5 rounded-full bg-[#4F7CF0]"
            animate={{ opacity: [0.3, 1, 0.3], y: [0, -4, 0] }}
            transition={{ duration: 0.8, repeat: Infinity, delay: d }}
          />
        ))}
      </div>
    </div>
  );

  // â”€â”€â”€ Render: Role Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const renderRoleSelection = () => {
    if (!analysisResult) return null;
    const { sceneType, sceneDescription, aiRole, userRoles, dialogueGoal, suggestedTopics } =
      analysisResult;

    return (
      <div className="flex-1 overflow-y-auto">
        {/* Scene Banner */}
        <div className="bg-gradient-to-br from-[#4F7CF0] to-[#7B5FE8] px-5 pt-5 pb-6">
          <div className="flex items-center gap-2 mb-3">
            <span className="text-xs bg-white/20 text-white px-2.5 py-1 rounded-full">
              ğŸ“Š é¢˜ç›®åˆ†æå®Œæˆ
            </span>
          </div>
          <div className="flex items-start gap-3">
            <div className="h-12 w-12 rounded-2xl bg-white/20 flex items-center justify-center shrink-0">
              <span className="text-2xl">{aiRole.emoji}</span>
            </div>
            <div>
              <p className="text-xs text-white/70 mb-0.5">{sceneType}</p>
              <h3 className="text-white font-semibold leading-snug">{scene.name}</h3>
            </div>
          </div>
          <p className="text-white/80 text-sm mt-3 leading-relaxed">{sceneDescription}</p>
        </div>

        <div className="px-5 pt-5 space-y-5 pb-4">
          {/* Dialogue Goal */}
          <div className="bg-[#FFF8EE] border border-[#FDE68A] rounded-2xl p-4">
            <div className="flex items-center gap-2 mb-2">
              <Target className="h-4 w-4 text-[#D97706]" />
              <span className="text-sm font-semibold text-[#92400E]">å¯¹è¯ç›®æ ‡</span>
            </div>
            <p className="text-sm text-[#78350F] leading-relaxed">{dialogueGoal}</p>
          </div>

          {/* Roles Section */}
          <div>
            <p className="text-sm font-semibold text-gray-700 mb-3">å¯¹è¯è§’è‰²</p>
            <div className="space-y-2.5">
              {/* AI Role */}
              <div className="bg-[#EEF2FF] border border-[#C7D7FD] rounded-2xl p-3.5 flex items-center gap-3">
                <span className="text-2xl">{aiRole.emoji}</span>
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-semibold text-gray-800">{aiRole.name}</span>
                    <span className="text-xs bg-[#4F7CF0] text-white px-2 py-0.5 rounded-full">
                      AI æ‰®æ¼”
                    </span>
                  </div>
                  <p className="text-xs text-gray-500 mt-0.5">{aiRole.description}</p>
                </div>
              </div>

              {/* User Roles */}
              {userRoles.map((role) => {
                const isSelected = selectedRole === role.id;
                return (
                  <button
                    key={role.id}
                    onClick={() => setSelectedRole(role.id)}
                    className={`w-full border-2 rounded-2xl p-3.5 flex items-center gap-3 text-left transition-all ${
                      isSelected
                        ? 'border-[#4F7CF0] bg-[#F0F4FF]'
                        : 'border-gray-100 bg-white'
                    }`}
                  >
                    <span className="text-2xl">{role.emoji}</span>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-semibold text-gray-800">{role.name}</span>
                        <span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">
                          ä½ æ‰®æ¼”
                        </span>
                      </div>
                      <p className="text-xs text-gray-500 mt-0.5">{role.description}</p>
                    </div>
                    <div
                      className={`h-5 w-5 rounded-full border-2 flex items-center justify-center shrink-0 ${
                        isSelected ? 'border-[#4F7CF0] bg-[#4F7CF0]' : 'border-gray-300'
                      }`}
                    >
                      {isSelected && <CheckCircle className="h-3.5 w-3.5 text-white" />}
                    </div>
                  </button>
                );
              })}
            </div>
          </div>

          {/* Difficulty */}
          <div>
            <p className="text-sm font-semibold text-gray-700 mb-3">éš¾åº¦ç­‰çº§</p>
            <div className="grid grid-cols-3 gap-2">
              {(Object.entries(DIFFICULTY_CONFIG) as [Difficulty, typeof DIFFICULTY_CONFIG[Difficulty]][]).map(
                ([key, cfg]) => (
                  <button
                    key={key}
                    onClick={() => setDifficulty(key)}
                    className={`border-2 rounded-2xl p-3 text-center transition-all ${
                      difficulty === key
                        ? `${cfg.bg} border-current ${cfg.color}`
                        : 'border-gray-100 bg-white text-gray-500'
                    }`}
                  >
                    <div className={`text-sm font-semibold ${difficulty === key ? cfg.color : 'text-gray-700'}`}>
                      {cfg.label}
                    </div>
                    <div className="text-[10px] text-gray-400 mt-0.5 leading-tight">{cfg.desc}</div>
                  </button>
                )
              )}
            </div>
          </div>

          {/* Suggested Topics */}
          <div>
            <p className="text-xs text-gray-400 mb-2">ç»ƒä¹ è¦ç‚¹å‚è€ƒ</p>
            <div className="flex flex-wrap gap-2">
              {suggestedTopics.map((topic) => (
                <span
                  key={topic}
                  className="text-xs bg-gray-100 text-gray-600 px-2.5 py-1 rounded-full"
                >
                  {topic}
                </span>
              ))}
            </div>
          </div>

          {/* Voice Toggle */}
          <div className="flex items-center justify-between bg-gray-50 rounded-2xl px-4 py-3">
            <div className="flex items-center gap-2">
              {voiceEnabled ? (
                <Volume2 className="h-4 w-4 text-[#4F7CF0]" />
              ) : (
                <VolumeX className="h-4 w-4 text-gray-400" />
              )}
              <span className="text-sm text-gray-700">AI è¯­éŸ³æ’­æ”¾</span>
            </div>
            <button
              onClick={() => setVoiceEnabled(!voiceEnabled)}
              className={`h-6 w-11 rounded-full transition-all relative ${
                voiceEnabled ? 'bg-[#4F7CF0]' : 'bg-gray-300'
              }`}
            >
              <motion.div
                className="h-5 w-5 bg-white rounded-full absolute top-0.5"
                animate={{ left: voiceEnabled ? '22px' : '2px' }}
                transition={{ type: 'spring', stiffness: 500, damping: 30 }}
              />
            </button>
          </div>

          {/* Start Button */}
          <motion.button
            whileTap={{ scale: 0.97 }}
            onClick={confirmRoleAndDifficulty}
            className="w-full h-13 bg-gradient-to-r from-[#4F7CF0] to-[#7B5FE8] text-white rounded-2xl font-semibold flex items-center justify-center gap-2 shadow-md py-4"
          >
            <MessageSquare className="h-5 w-5" />
            å¼€å§‹å¯¹è¯ç»ƒä¹ 
            <ChevronRight className="h-4 w-4" />
          </motion.button>
        </div>
      </div>
    );
  };

  // â”€â”€â”€ Render: Initializing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const renderInitializing = () => (
    <div className="flex-1 flex flex-col items-center justify-center px-6 gap-5">
      <motion.div
        className="h-20 w-20 rounded-full bg-gradient-to-br from-[#4F7CF0] to-[#7B5FE8] flex items-center justify-center shadow-xl"
        animate={{ rotate: 360 }}
        transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
      >
        <Loader2 className="h-10 w-10 text-white" />
      </motion.div>
      <div className="text-center">
        <h3 className="font-semibold text-gray-800 mb-1">æ­£åœ¨å»ºç«‹å¯¹è¯...</h3>
        <p className="text-sm text-gray-400">AI æ­£åœ¨å‡†å¤‡åˆå§‹å›å¤ï¼Œå³å°†å¼€å§‹</p>
      </div>
      <div className="flex gap-1.5">
        {[0, 0.2, 0.4].map((d, i) => (
          <motion.div
            key={i}
            className="h-2 w-2 rounded-full bg-[#4F7CF0]"
            animate={{ opacity: [0.3, 1, 0.3] }}
            transition={{ duration: 0.8, repeat: Infinity, delay: d }}
          />
        ))}
      </div>
    </div>
  );

  // â”€â”€â”€ Render: Active Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const renderActive = () => {
    const aiRole = analysisResult?.aiRole;
    const canSend = !isGenerating && !isRecording;

    return (
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Progress bar */}
        <div className="px-4 pt-2 pb-1">
          <div className="flex items-center justify-between mb-1.5">
            <span className="text-xs text-gray-400">
              ç¬¬ {Math.min(currentRound, MAX_ROUNDS)} / {MAX_ROUNDS} è½®
            </span>
            <span className="text-xs text-[#4F7CF0] font-medium">
              {Math.round((Math.min(currentRound, MAX_ROUNDS) / MAX_ROUNDS) * 100)}%
            </span>
          </div>
          <div className="h-1.5 bg-gray-100 rounded-full overflow-hidden">
            <motion.div
              className="h-full bg-gradient-to-r from-[#4F7CF0] to-[#7B5FE8] rounded-full"
              animate={{
                width: `${(Math.min(currentRound, MAX_ROUNDS) / MAX_ROUNDS) * 100}%`,
              }}
              transition={{ duration: 0.4 }}
            />
          </div>
        </div>

        {/* Messages */}
        <div className="flex-1 overflow-y-auto px-4 py-3 space-y-4">
          <AnimatePresence initial={false}>
            {messages.map((msg) => (
              <motion.div
                key={msg.id}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} items-end gap-2`}
              >
                {msg.role === 'ai' && (
                  <div className="h-8 w-8 rounded-full bg-gradient-to-br from-[#4F7CF0] to-[#7B5FE8] flex items-center justify-center shrink-0 shadow-sm">
                    <span className="text-sm">{aiRole?.emoji || 'ğŸ¤–'}</span>
                  </div>
                )}
                <div className="flex flex-col gap-1 max-w-[78%]">
                  {msg.role === 'ai' && (
                    <span className="text-[10px] text-gray-400 ml-1">{aiRole?.name || 'AI'}</span>
                  )}
                  <div
                    className={`rounded-2xl px-4 py-2.5 leading-relaxed text-sm ${
                      msg.role === 'user'
                        ? 'bg-[#4F7CF0] text-white rounded-br-sm'
                        : 'bg-white border border-gray-100 text-gray-700 rounded-bl-sm shadow-sm'
                    }`}
                  >
                    {msg.text}
                  </div>
                  {msg.role === 'ai' && voiceEnabled && (
                    <button
                      onClick={() => speak(msg.text)}
                      className="flex items-center gap-1 text-[10px] text-gray-400 ml-1 hover:text-[#4F7CF0] transition-colors"
                    >
                      <Volume2 className="h-3 w-3" />
                      é‡æ–°æ’­æ”¾
                    </button>
                  )}
                </div>
                {msg.role === 'user' && (
                  <div className="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center shrink-0">
                    <span className="text-xs text-gray-500">æˆ‘</span>
                  </div>
                )}
              </motion.div>
            ))}
          </AnimatePresence>

          {/* AI Generating Indicator */}
          {isGenerating && (
            <motion.div
              initial={{ opacity: 0, y: 8 }}
              animate={{ opacity: 1, y: 0 }}
              className="flex items-end gap-2"
            >
              <div className="h-8 w-8 rounded-full bg-gradient-to-br from-[#4F7CF0] to-[#7B5FE8] flex items-center justify-center shrink-0 shadow-sm">
                <span className="text-sm">{aiRole?.emoji || 'ğŸ¤–'}</span>
              </div>
              <div className="bg-white border border-gray-100 rounded-2xl rounded-bl-sm px-4 py-3 shadow-sm flex items-center gap-1.5">
                {[0, 0.18, 0.36].map((d, i) => (
                  <motion.div
                    key={i}
                    className="h-2 w-2 rounded-full bg-gray-300"
                    animate={{ opacity: [0.4, 1, 0.4], scale: [0.8, 1.1, 0.8] }}
                    transition={{ duration: 0.7, repeat: Infinity, delay: d }}
                  />
                ))}
              </div>
            </motion.div>
          )}

          {/* Speaking Indicator */}
          {isSpeaking && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              className="flex items-center justify-center gap-2 py-1"
            >
              <div className="flex items-center gap-1">
                {[0, 0.1, 0.2, 0.1, 0].map((d, i) => (
                  <motion.div
                    key={i}
                    className="w-1 rounded-full bg-[#4F7CF0]"
                    animate={{ height: ['6px', '14px', '6px'] }}
                    transition={{ duration: 0.5, repeat: Infinity, delay: d }}
                  />
                ))}
              </div>
              <span className="text-[10px] text-[#4F7CF0]">AI æ­£åœ¨è¯´è¯</span>
            </motion.div>
          )}

          <div ref={messagesEndRef} />
        </div>

        {/* Error */}
        {error && (
          <div className="mx-4 mb-2 bg-red-50 border border-red-200 rounded-xl px-3 py-2 text-xs text-red-600 flex items-center gap-2">
            <span>âš ï¸</span>
            {error}
            <button onClick={() => setError(null)} className="ml-auto text-red-400">âœ•</button>
          </div>
        )}

        {/* Input Bar */}
        <div className="bg-white border-t border-gray-100 px-4 py-3 flex items-center gap-2">
          {/* Voice Button */}
          <motion.button
            whileTap={{ scale: 0.92 }}
            onClick={toggleRecording}
            disabled={isGenerating}
            className={`h-11 w-11 rounded-full flex items-center justify-center shrink-0 transition-all ${
              isRecording
                ? 'bg-red-500 shadow-lg shadow-red-200'
                : 'bg-gray-100 hover:bg-gray-200 disabled:opacity-40'
            }`}
          >
            {isRecording ? (
              <motion.div
                animate={{ scale: [1, 1.2, 1] }}
                transition={{ duration: 0.5, repeat: Infinity }}
              >
                <MicOff className="h-5 w-5 text-white" />
              </motion.div>
            ) : (
              <Mic className="h-5 w-5 text-gray-500" />
            )}
          </motion.button>

          {/* Text Input */}
          <input
            ref={inputRef}
            value={textInput}
            onChange={(e) => setTextInput(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && canSend && sendMessage(textInput)}
            placeholder={isRecording ? 'æ­£åœ¨å½•éŸ³...' : 'ç”¨è‹±è¯­å›å¤...'}
            disabled={!canSend}
            className="flex-1 bg-gray-100 rounded-2xl px-4 py-2.5 text-sm text-gray-700 placeholder:text-gray-400 outline-none disabled:opacity-60"
          />

          {/* Send Button */}
          <motion.button
            whileTap={{ scale: 0.92 }}
            onClick={() => canSend && textInput.trim() && sendMessage(textInput)}
            disabled={!canSend || !textInput.trim()}
            className="h-11 w-11 rounded-full bg-[#4F7CF0] flex items-center justify-center shrink-0 disabled:opacity-40 transition-opacity"
          >
            <Send className="h-4.5 w-4.5 text-white" style={{ height: '18px', width: '18px' }} />
          </motion.button>
        </div>

        {/* Recording hint */}
        {isRecording && (
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            animate={{ opacity: 1, y: 0 }}
            className="absolute bottom-20 left-1/2 -translate-x-1/2 bg-red-500 text-white text-xs px-4 py-2 rounded-full shadow-lg flex items-center gap-2"
          >
            <motion.div
              className="h-2 w-2 rounded-full bg-white"
              animate={{ opacity: [1, 0.2, 1] }}
              transition={{ duration: 0.6, repeat: Infinity }}
            />
            æ­£åœ¨å½•éŸ³ï¼Œç‚¹å‡»éº¦å…‹é£åœæ­¢
          </motion.div>
        )}
      </div>
    );
  };

  // â”€â”€â”€ Render: Completed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const renderCompleted = () => {
    if (isAnalyzingPerf || !performance) {
      return (
        <div className="flex-1 flex flex-col items-center justify-center gap-5 px-6">
          <div className="h-20 w-20 rounded-full bg-gradient-to-br from-[#4F7CF0] to-[#7B5FE8] flex items-center justify-center shadow-xl">
            <Loader2 className="h-10 w-10 text-white animate-spin" />
          </div>
          <div className="text-center">
            <h3 className="font-semibold text-gray-800 mb-1">AI æ­£åœ¨è¯„æµ‹è¡¨ç°...</h3>
            <p className="text-sm text-gray-400">åˆ†æå¯¹è¯è´¨é‡ï¼Œç”Ÿæˆè¯¦ç»†æŠ¥å‘Š</p>
          </div>
          <div className="flex gap-1.5">
            {[0, 0.2, 0.4].map((d, i) => (
              <motion.div
                key={i}
                className="h-2.5 w-2.5 rounded-full bg-[#4F7CF0]"
                animate={{ opacity: [0.3, 1, 0.3], y: [0, -5, 0] }}
                transition={{ duration: 0.8, repeat: Infinity, delay: d }}
              />
            ))}
          </div>
        </div>
      );
    }

    const scoreColor =
      performance.score >= 85
        ? 'text-[#22C55E]'
        : performance.score >= 70
        ? 'text-[#4F7CF0]'
        : 'text-[#F59E0B]';
    const scoreGradient =
      performance.score >= 85
        ? 'from-[#22C55E] to-[#4ADE80]'
        : performance.score >= 70
        ? 'from-[#4F7CF0] to-[#7B5FE8]'
        : 'from-[#F59E0B] to-[#FBBF24]';

    return (
      <div className="flex-1 overflow-y-auto">
        {/* Header */}
        <div className={`bg-gradient-to-br ${scoreGradient} px-5 pt-6 pb-8 text-center`}>
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            transition={{ type: 'spring', stiffness: 260, damping: 20 }}
            className="h-20 w-20 rounded-full bg-white/20 flex items-center justify-center mx-auto mb-4 shadow-xl"
          >
            <Trophy className="h-10 w-10 text-white" />
          </motion.div>
          <h2 className="text-white mb-1">å¯¹è¯å®Œæˆï¼</h2>
          <p className="text-white/80 text-sm">å®Œæˆäº†ã€Œ{scene.name}ã€å¼€æ”¾å¼å¯¹è¯ç»ƒä¹ </p>
          <motion.div
            initial={{ opacity: 0, scale: 0.5 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.3 }}
            className="mt-4 inline-flex items-baseline gap-1 bg-white/20 rounded-2xl px-6 py-3"
          >
            <span className="text-4xl font-semibold text-white">{performance.score}</span>
            <span className="text-white/80 text-sm">åˆ†</span>
          </motion.div>
        </div>

        <div className="px-5 -mt-2 space-y-4 pb-6">
          {/* Dimension scores */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
            <p className="text-sm font-semibold text-gray-700 mb-3">ç»´åº¦è¯„åˆ†</p>
            {[
              { label: 'è¡¨è¾¾æµåˆ©åº¦', value: performance.fluency, color: '#4F7CF0' },
              { label: 'è¯æ±‡ä¸°å¯Œåº¦', value: performance.vocabulary, color: '#34D399' },
              { label: 'è¯­è¨€å‡†ç¡®æ€§', value: performance.accuracy, color: '#F59E0B' },
            ].map((dim) => (
              <div key={dim.label} className="mb-3 last:mb-0">
                <div className="flex justify-between items-center mb-1.5">
                  <span className="text-xs text-gray-600">{dim.label}</span>
                  <span className="text-xs font-semibold text-gray-700">{dim.value}åˆ†</span>
                </div>
                <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                  <motion.div
                    className="h-full rounded-full"
                    style={{ background: dim.color }}
                    initial={{ width: 0 }}
                    animate={{ width: `${dim.value}%` }}
                    transition={{ duration: 0.7, delay: 0.2 }}
                  />
                </div>
              </div>
            ))}
          </div>

          {/* Summary */}
          <div className="bg-[#EEF2FF] rounded-2xl p-4">
            <div className="flex items-start gap-2">
              <Star className="h-4 w-4 text-[#4F7CF0] shrink-0 mt-0.5" />
              <p className="text-sm text-[#3B4FD8] leading-relaxed">{performance.summary}</p>
            </div>
          </div>

          {/* Strengths */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
            <p className="text-sm font-semibold text-gray-700 mb-2.5">âœ… è¡¨ç°äº®ç‚¹</p>
            <ul className="space-y-2">
              {performance.strengths.map((s, i) => (
                <li key={i} className="flex items-start gap-2 text-sm text-gray-600">
                  <span className="text-[#22C55E] shrink-0">â€¢</span>
                  {s}
                </li>
              ))}
            </ul>
          </div>

          {/* Suggestions */}
          <div className="bg-[#FFFBEB] border border-[#FDE68A] rounded-2xl p-4">
            <p className="text-sm font-semibold text-[#92400E] mb-2.5">ğŸ’¡ æ”¹è¿›å»ºè®®</p>
            <ul className="space-y-2">
              {performance.suggestions.map((s, i) => (
                <li key={i} className="flex items-start gap-2 text-sm text-[#78350F]">
                  <span className="text-[#D97706] shrink-0">â€¢</span>
                  {s}
                </li>
              ))}
            </ul>
          </div>

          {/* Action Buttons */}
          <div className="space-y-2.5 pt-1">
            <motion.button
              whileTap={{ scale: 0.97 }}
              onClick={handleFinish}
              className="w-full h-12 bg-gradient-to-r from-[#4F7CF0] to-[#7B5FE8] text-white rounded-2xl font-medium shadow-sm"
            >
              å®Œæˆæµ‹è¯• ğŸ‰
            </motion.button>
            <button
              onClick={() => {
                setStatus('role-selection');
                setMessages([]);
                setCurrentRound(0);
                setPerformance(null);
                setError(null);
              }}
              className="w-full h-12 border border-gray-200 text-gray-600 rounded-2xl font-medium flex items-center justify-center gap-2"
            >
              <RotateCcw className="h-4 w-4" />
              å†æ¥ä¸€æ¬¡
            </button>
          </div>
        </div>
      </div>
    );
  };

  // â”€â”€â”€ Main Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  return (
    <div className="flex flex-col h-screen bg-[#F5F6FA] max-w-[430px] mx-auto relative">
      {/* Top Bar */}
      <div className="bg-white border-b border-gray-100 px-4 py-3 flex items-center gap-3 shrink-0">
        <button
          onClick={() => {
            stopSpeak();
            recognitionRef.current?.stop();
            onBack();
          }}
          className="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center shrink-0"
        >
          <ArrowLeft className="h-4 w-4 text-gray-600" />
        </button>
        <div className="flex-1 min-w-0">
          <p className="text-sm font-semibold text-gray-800 truncate">{scene.name}</p>
          <p className="text-xs text-gray-400">
            {status === 'analyzing' && 'æ­£åœ¨åˆ†æé¢˜ç›®...'}
            {status === 'role-selection' && 'é€‰æ‹©è§’è‰²å’Œéš¾åº¦'}
            {status === 'initializing' && 'æ­£åœ¨åˆå§‹åŒ–...'}
            {status === 'active' && `å¼€æ”¾å¼å¯¹è¯ Â· ç¬¬ ${Math.min(currentRound, MAX_ROUNDS)}/${MAX_ROUNDS} è½®`}
            {status === 'completed' && 'å¯¹è¯å®Œæˆ Â· æŸ¥çœ‹è¯„æµ‹æŠ¥å‘Š'}
          </p>
        </div>

        {/* Mute toggle (visible in active) */}
        {status === 'active' && (
          <button
            onClick={() => {
              setVoiceEnabled(!voiceEnabled);
              if (voiceEnabled) stopSpeak();
            }}
            className={`h-8 w-8 rounded-full flex items-center justify-center transition-all ${
              voiceEnabled ? 'bg-[#EEF2FF]' : 'bg-gray-100'
            }`}
          >
            {voiceEnabled ? (
              <Volume2 className="h-4 w-4 text-[#4F7CF0]" />
            ) : (
              <VolumeX className="h-4 w-4 text-gray-400" />
            )}
          </button>
        )}
      </div>

      {/* Content */}
      <AnimatePresence mode="wait">
        <motion.div
          key={status}
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -12 }}
          transition={{ duration: 0.22 }}
          className="flex-1 flex flex-col overflow-hidden"
        >
          {status === 'analyzing' && renderAnalyzing()}
          {status === 'role-selection' && renderRoleSelection()}
          {status === 'initializing' && renderInitializing()}
          {status === 'active' && renderActive()}
          {status === 'completed' && renderCompleted()}
        </motion.div>
      </AnimatePresence>
    </div>
  );
}
