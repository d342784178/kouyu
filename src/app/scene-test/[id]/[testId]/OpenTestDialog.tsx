'use client'

import { useState, useEffect, useRef } from 'react'
import Link from 'next/link'
import { motion, AnimatePresence } from 'framer-motion'
import TestAnalysis from './TestAnalysis'
import LoadingSpinner from './components/LoadingSpinner'

// 定义消息类型
interface Message {
  role: 'assistant' | 'user'
  content: string
  audioUrl?: string
  timestamp: number
}

// 定义测试状态类型
type TestStatus = 'idle' | 'analyzing' | 'role-selection' | 'initializing' | 'active' | 'completed'

// 定义题目分析结果类型
interface QuestionAnalysis {
  scene: string
  roles: string[]
  dialogueGoal: string
}

interface OpenTestDialogProps {
  sceneId: string
  testId: string
  testQuestion: string
  currentIndex?: number
  totalTests?: number
  onComplete: () => void
  autoStart?: boolean
}

export default function OpenTestDialog({ sceneId, testId, testQuestion, currentIndex, totalTests, onComplete, autoStart = false }: OpenTestDialogProps) {
  // 状态管理
  const [status, setStatus] = useState<TestStatus>('idle')
  const [messages, setMessages] = useState<Message[]>([])
  const [currentRound, setCurrentRound] = useState(0)
  const [maxRounds] = useState(5)
  const [isRecording, setIsRecording] = useState(false)
  const [playingMessageIndex, setPlayingMessageIndex] = useState<number | null>(null)
  const [recognition, setRecognition] = useState<any>(null)
  const [audioElement, setAudioElement] = useState<HTMLAudioElement | null>(null)
  const [loading, setLoading] = useState(false)
  const [isRecognizing, setIsRecognizing] = useState(false)
  const [isGeneratingResponse, setIsGeneratingResponse] = useState(false)
  const [error, setError] = useState<string>('')
  const [showAnalysis, setShowAnalysis] = useState(false)

  // 新增状态
  const [questionAnalysis, setQuestionAnalysis] = useState<QuestionAnalysis | null>(null)
  const [selectedRole, setSelectedRole] = useState<string>('')
  const [difficultyLevel, setDifficultyLevel] = useState<string>('Intermediate')

  // 使用 ref 来存储最新的状态，避免闭包问题
  const messagesRef = useRef<Message[]>([])
  const currentRoundRef = useRef<number>(0)
  
  // 同步状态到 ref
  useEffect(() => {
    messagesRef.current = messages
  }, [messages])
  
  useEffect(() => {
    currentRoundRef.current = currentRound
  }, [currentRound])

  // 文本输入状态
  const [showTextInput, setShowTextInput] = useState(false)
  const [textInput, setTextInput] = useState('')

  const messagesEndRef = useRef<HTMLDivElement>(null)

  // 初始化语音识别
  useEffect(() => {
    if ('webkitSpeechRecognition' in window) {
      const SpeechRecognition = (window as any).webkitSpeechRecognition
      const recognition = new SpeechRecognition()
      recognition.continuous = false
      recognition.interimResults = false
      recognition.lang = 'en-US'
      
      recognition.onresult = (event: any) => {
        const transcript = event.results[0][0].transcript
        handleVoiceInput(transcript)
      }
      
      recognition.onerror = (event: any) => {
        console.error('语音识别错误:', event.error)
        setError('语音识别失败，请重试')
        setIsRecording(false)
      }
      
      recognition.onend = () => {
        setIsRecording(false)
      }
      
      setRecognition(recognition)
    }
  }, [])

  // 滚动到最新消息
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  // 自动开始分析（如果设置了autoStart）
  useEffect(() => {
    if (autoStart && testQuestion && status === 'idle') {
      console.log('[OpenTestDialog] 自动开始分析题目')
      analyzeQuestion()
    }
  }, [autoStart, testQuestion])

  // 分析测试题目
  const analyzeQuestion = async () => {
    setStatus('analyzing')
    setError('')
    
    try {
      console.log('开始分析测试题目:', testQuestion)
      
      // 构建题目分析请求
      const analysisRequest = {
        topic: testQuestion,
        sceneId: sceneId,
        testId: testId
      }
      
      console.log('题目分析请求:', JSON.stringify(analysisRequest, null, 2))
      
      // 调用API分析题目
      const response = await fetch('/api/open-test/analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(analysisRequest),
      })
      
      const data = await response.json()
      console.log('题目分析响应:', JSON.stringify(data, null, 2))
      
      if (!response.ok) {
        throw new Error(data.error || '题目分析失败')
      }
      
      // 解析分析结果
      const analysisResult: QuestionAnalysis = {
        scene: data.scene || 'General',
        roles: data.roles || ['User', 'Assistant'],
        dialogueGoal: data.dialogueGoal || 'Practice English conversation'
      }
      
      console.log('解析的题目分析结果:', analysisResult)
      
      setQuestionAnalysis(analysisResult)
      setStatus('role-selection')
    } catch (err) {
      console.error('题目分析失败:', err)
      const errorMessage = err instanceof Error ? err.message : '题目分析失败，请重试'
      setError(errorMessage)
      setStatus('idle')
    }
  }

  // 初始化测试
  const startTest = async () => {
    // 首先分析题目
    await analyzeQuestion()
  }

  // 确认角色和难度等级，开始对话
  const confirmRoleAndDifficulty = async () => {
    if (!selectedRole) {
      setError('请选择一个角色')
      return
    }
    
    setStatus('initializing')
    setError('')
    
    try {
      console.log('确认角色和难度等级:', {
        selectedRole,
        difficultyLevel,
        questionAnalysis
      })
      
      // 构建初始化请求，包含场景、角色和难度等级信息
      const initRequest = {
        sceneId,
        testId,
        scene: questionAnalysis?.scene,
        aiRole: selectedRole === questionAnalysis?.roles[0] ? questionAnalysis?.roles[1] : questionAnalysis?.roles[0],
        userRole: selectedRole,
        dialogueGoal: questionAnalysis?.dialogueGoal,
        difficultyLevel
      }
      
      console.log('初始化对话请求:', JSON.stringify(initRequest, null, 2))
      
      // 调用API生成初始对话
      const response = await fetch('/api/open-test/initiate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(initRequest),
      })
      
      const data = await response.json()
      console.log('初始化对话响应:', JSON.stringify(data, null, 2))
      
      if (!response.ok) {
        throw new Error(data.error || '初始化对话失败')
      }
      
      // 构建初始消息
      const initialMessage: Message = {
        role: 'assistant',
        content: data.message,
        audioUrl: data.audioUrl,
        timestamp: Date.now(),
      }
      
      console.log('生成的初始消息:', initialMessage)
      
      // 构建对话历史，只包含AI的初始回复
      const completeHistory: Message[] = [initialMessage]
      
      console.log('初始化对话历史:', completeHistory)
      
      setMessages(completeHistory)
      setCurrentRound(1)
      setStatus('active')
      
      // 自动播放初始语音
      if (initialMessage.audioUrl) {
        console.log('自动播放初始语音:', initialMessage.audioUrl)
        setTimeout(() => {
          playAudio(initialMessage.audioUrl!, 0)
        }, 500)
      }
    } catch (err) {
      console.error('初始化对话失败:', err)
      const errorMessage = err instanceof Error ? err.message : '初始化对话失败，请重试'
      setError(errorMessage)
      setStatus('role-selection')
    }
  }

  // 生成助手消息（继续对话）
  const generateAssistantMessage = async (prompt: string, conversationHistory: Message[], round: number): Promise<{ message: Message; isEnd: boolean }> => {
    setLoading(true)
    
    try {
      console.log('=== 开始生成助手消息（继续对话）===')
      console.log('用户输入:', prompt)
      console.log('完整对话历史:', conversationHistory)
      console.log('当前轮数:', round)
      console.log('questionAnalysis:', questionAnalysis)
      console.log('selectedRole:', selectedRole)
      
      // 构建完整的对话历史，包含所有角色信息
      const updatedHistory = conversationHistory.map(msg => ({
        role: msg.role,
        content: msg.content
      }))
      
      // 构建完整的API请求，包含场景、角色和难度等级信息
      const apiRequest = {
        sceneId,
        testId,
        conversation: updatedHistory, // 传递完整的对话历史
        round,
        maxRounds,
        scene: questionAnalysis?.scene || '餐厅',
        aiRole: selectedRole === questionAnalysis?.roles[0] ? questionAnalysis?.roles[1] : questionAnalysis?.roles[0] || '服务员',
        userRole: selectedRole || '顾客',
        dialogueGoal: questionAnalysis?.dialogueGoal || '顾客点餐',
        difficultyLevel
      }
      
      console.log('API 请求参数:', JSON.stringify(apiRequest, null, 2))
      
      const response = await fetch('/api/open-test/continue', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(apiRequest),
      })
      
      const data = await response.json()
      console.log('API 响应状态:', response.status)
      console.log('API 响应数据:', JSON.stringify(data, null, 2))
      
      if (!response.ok) {
        // 处理后端返回的错误
        console.error('大模型 API 调用失败:', data)
        throw new Error(data.error || '大模型 API 调用失败')
      }
      
      const assistantMessage = {
        role: 'assistant' as const,
        content: data.message,
        audioUrl: data.audioUrl,
        timestamp: Date.now(),
      }
      
      console.log('生成的助手消息:', assistantMessage)
      console.log('是否结束对话:', data.isEnd || false)
      
      return {
        message: assistantMessage,
        isEnd: data.isEnd || false
      }
    } catch (err) {
      console.error('生成助手消息失败:', err)
      // 抛出错误，让调用者处理
      throw err
    } finally {
      setLoading(false)
      console.log('=== 生成助手消息完成 ===')
    }
  }

  // 处理语音输入
  const handleVoiceInput = async (transcript: string) => {
    if (!transcript.trim()) return
    
    // 使用 ref 获取最新的状态
    const currentMessages = messagesRef.current
    const currentRoundValue = currentRoundRef.current
    
    console.log('=== 开始处理语音输入 ===')
    console.log('当前消息状态:', currentMessages)
    console.log('用户输入:', transcript)
    console.log('当前轮数:', currentRoundValue)
    
    // 添加用户消息
    const userMessage: Message = {
      role: 'user',
      content: transcript,
      timestamp: Date.now(),
    }
    
    // 立即更新状态，展示用户消息
    const updatedMessages = [...currentMessages, userMessage]
    setMessages(updatedMessages)
    console.log('添加用户消息后的对话历史:', updatedMessages)
    
    // 显示AI正在输入的加载状态
    setIsGeneratingResponse(true)
    
    try {
      // 生成助手回应，传递完整的对话历史和下一轮轮数
      console.log('调用generateAssistantMessage，使用完整对话历史')
      const nextRound = currentRoundValue + 1
      console.log('传递的轮数:', nextRound)
      const { message: assistantMessage, isEnd } = await generateAssistantMessage(transcript, updatedMessages, nextRound)
      console.log('收到助手消息:', assistantMessage)
      
      // 构建包含用户消息和助手消息的完整对话历史
      const completeHistory = [...updatedMessages, assistantMessage]
      console.log('添加助手消息后的完整对话历史:', completeHistory)
      
      // 更新消息状态
      setMessages(completeHistory)
      
      // 增加轮数
      console.log('更新轮数:', nextRound)
      setCurrentRound(nextRound)
      
      // 自动播放AI生成的语音
      if (assistantMessage.audioUrl) {
        console.log('自动播放AI语音:', assistantMessage.audioUrl)
        setTimeout(() => {
          playAudio(assistantMessage.audioUrl!, completeHistory.length - 1)
        }, 500)
      }
      
      // 检查是否结束对话
      if (isEnd || nextRound >= maxRounds) {
        console.log('对话结束，开始分析测试结果')
        // 结束测试
        await endTest()
      }
    } catch (err) {
      console.error('处理语音输入失败:', err)
      const errorMessage = err instanceof Error ? err.message : '处理输入失败，请重试'
      setError(errorMessage)
    } finally {
      setIsGeneratingResponse(false)
      console.log('=== 语音输入处理完成 ===')
    }
  }

  // 开始录音
  const startRecording = () => {
    if (recognition && !isRecording && !loading) {
      try {
        setIsRecording(true)
        setError('')
        recognition.start()
        
        // 设置30秒的最大录音时间限制
        setTimeout(() => {
          if (isRecording) {
            stopRecording()
          }
        }, 30000)
      } catch (err) {
        console.error('启动录音失败:', err)
        setError('启动录音失败，请重试')
        setIsRecording(false)
      }
    }
  }

  // 停止录音
  const stopRecording = () => {
    if (recognition && isRecording) {
      try {
        recognition.stop()
        setIsRecording(false)
      } catch (err) {
        console.error('停止录音失败:', err)
        setIsRecording(false)
      }
    }
  }

  // 播放语音
  const playAudio = (audioUrl: string, messageIndex: number) => {
    // 如果点击的是正在播放的消息，则暂停
    if (playingMessageIndex === messageIndex && audioElement) {
      audioElement.pause()
      setPlayingMessageIndex(null)
      setAudioElement(null)
      return
    }
    
    // 暂停其他正在播放的音频
    if (audioElement) {
      audioElement.pause()
    }
    
    const audio = new Audio(audioUrl)
    setAudioElement(audio)
    setPlayingMessageIndex(messageIndex)
    
    audio.play()
    
    audio.onended = () => {
      setPlayingMessageIndex(null)
      setAudioElement(null)
    }
    
    audio.onerror = () => {
      setPlayingMessageIndex(null)
      setAudioElement(null)
      setError('语音播放失败')
    }
  }

  // 结束测试
  const endTest = async () => {
    setStatus('analyzing')
    setLoading(true)
    
    try {
      // 使用 ref 获取最新的状态
      const currentMessages = messagesRef.current
      const currentRoundValue = currentRoundRef.current
      
      console.log('开始分析测试结果...')
      console.log('对话历史:', currentMessages)
      
      // 调用测试分析 API
    const analysisResponse = await fetch('/api/open-test/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        sceneId,
        testId,
        conversation: currentMessages,
        rounds: currentRoundValue
      })
    })
      
      if (!analysisResponse.ok) {
        const errorData = await analysisResponse.json()
        console.error('测试分析 API 调用失败:', errorData)
        throw new Error(errorData.error || '测试分析 API 调用失败')
      }
      
      const analysisData = await analysisResponse.json()
      console.log('测试分析结果:', analysisData)
      
      setStatus('completed')
      // 显示测试分析
      setShowAnalysis(true)
    } catch (err) {
      console.error('结束测试失败:', err)
      const errorMessage = err instanceof Error ? err.message : '结束测试失败，请重试'
      setError(errorMessage)
      setStatus('active')
    } finally {
      setLoading(false)
    }
  }

  // 渲染消息气泡
  const renderMessage = (message: Message, index: number) => {
    return (
      <div 
        key={index} 
        className={`flex ${message.role === 'assistant' ? 'justify-start' : 'justify-end'} mb-4`}
      >
        <div className={`max-w-[80%] p-4 rounded-lg ${message.role === 'assistant' ? 'bg-blue-50 text-blue-800' : 'bg-green-50 text-green-800'}`}>
          <p className="text-sm">{message.content}</p>
          {message.audioUrl && (
            <button 
              className="mt-2 text-xs flex items-center text-primary"
              onClick={() => playAudio(message.audioUrl!, index)}
            >
              <i className={`fas ${playingMessageIndex === index ? 'fa-pause' : 'fa-play'} mr-1`}></i>
              {playingMessageIndex === index ? '暂停' : '播放语音'}
            </button>
          )}
        </div>
      </div>
    )
  }

  // 渲染不同状态的界面
  const renderContent = () => {
    switch (status) {
      case 'idle':
        const hasSpeechSupport = 'webkitSpeechRecognition' in window
        return (
          <div className="text-center py-12 px-6">
            <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-r from-purple-400 to-purple-600 flex items-center justify-center shadow-card">
              <i className="fas fa-comments text-white text-2xl"></i>
            </div>
            <h3 className="text-lg font-semibold text-text-primary mb-4">开放题测试</h3>
            <div className="bg-white rounded-card shadow-card p-4 mb-6">
              <p className="text-sm text-text-primary">{testQuestion}</p>
            </div>
            <p className="text-sm text-text-secondary mb-8">
              您将与AI进行3轮对话，通过语音回答问题
            </p>
            {!hasSpeechSupport && (
              <div className="bg-amber-50 border border-amber-200 rounded-card p-4 mb-8">
                <p className="text-sm text-amber-700">
                  <i className="fas fa-exclamation-triangle mr-2"></i>
                  您的浏览器不支持语音识别功能，请使用支持的浏览器（如Chrome）
                </p>
              </div>
            )}
            <button
              className={`w-full py-4 rounded-card font-semibold text-sm ${hasSpeechSupport
                ? 'bg-primary text-white shadow-card hover:shadow-card-hover'
                : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
              onClick={startTest}
              disabled={!hasSpeechSupport}
            >
              开始测试
            </button>
          </div>
        )
      
      case 'analyzing':
        return (
          <div className="flex flex-col items-center justify-center py-12">
            <div className="w-10 h-10 border-2 border-purple-400 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p className="text-sm text-text-secondary font-medium">正在分析题目...</p>
            <p className="text-xs text-text-secondary mt-1">AI 正在理解场景、角色和对话目标</p>
          </div>
        )
      
      case 'role-selection':
        return (
          <div className="py-8 px-6">
            <h3 className="text-lg font-semibold text-text-primary mb-6 text-center">题目分析结果</h3>

            {/* 题目分析结果 */}
            <div className="bg-purple-50 rounded-card p-4 mb-6 border border-purple-100">
              <div className="grid grid-cols-1 gap-3">
                <div className="bg-white p-3 rounded-card shadow-card">
                  <h4 className="text-xs font-medium text-text-secondary mb-1">场景</h4>
                  <p className="text-sm text-text-primary font-medium">{questionAnalysis?.scene || '一般场景'}</p>
                </div>
                <div className="bg-white p-3 rounded-card shadow-card">
                  <h4 className="text-xs font-medium text-text-secondary mb-1">角色</h4>
                  <p className="text-sm text-text-primary font-medium">{questionAnalysis?.roles.join(' / ') || '用户 / 助手'}</p>
                </div>
                <div className="bg-white p-3 rounded-card shadow-card">
                  <h4 className="text-xs font-medium text-text-secondary mb-1">对话目标</h4>
                  <p className="text-sm text-text-primary font-medium">{questionAnalysis?.dialogueGoal || '练习英语对话'}</p>
                </div>
              </div>
            </div>

            {/* 角色选择 */}
            <div className="mb-6">
              <h4 className="text-sm font-semibold text-text-primary mb-3">选择角色</h4>
              <div className="grid grid-cols-2 gap-3">
                {(questionAnalysis?.roles || ['用户', '助手']).map((role, index) => (
                  <button
                    key={index}
                    className={`p-3 rounded-card border text-sm font-medium transition-all ${selectedRole === role
                      ? 'border-primary bg-blue-50 text-primary shadow-card'
                      : 'border-border-light bg-white text-text-secondary'}`}
                    onClick={() => setSelectedRole(role)}
                  >
                    <span className="block">{role}</span>
                    <span className="text-xs mt-1 block opacity-70">
                      {selectedRole === role ? '已选择' : '点击选择'}
                    </span>
                  </button>
                ))}
              </div>
            </div>

            {/* 难度等级选择 */}
            <div className="mb-6">
              <h4 className="text-sm font-semibold text-text-primary mb-3">选择难度等级</h4>
              <div className="grid grid-cols-3 gap-3">
                {[
                  { value: 'Beginner', label: '初级' },
                  { value: 'Intermediate', label: '中级' },
                  { value: 'Advanced', label: '高级' }
                ].map((level) => (
                  <button
                    key={level.value}
                    className={`p-3 rounded-card border text-sm font-medium transition-all ${difficultyLevel === level.value
                      ? 'border-primary bg-blue-50 text-primary shadow-card'
                      : 'border-border-light bg-white text-text-secondary'}`}
                    onClick={() => setDifficultyLevel(level.value)}
                  >
                    {level.label}
                  </button>
                ))}
              </div>
            </div>

            {/* 开始对话按钮 */}
            <div className="text-center">
              <button
                className="w-full py-4 bg-primary text-white rounded-card font-semibold text-sm shadow-card hover:shadow-card-hover"
                onClick={confirmRoleAndDifficulty}
              >
                开始对话
              </button>
            </div>

            {error && (
              <div className="mt-4 text-center text-danger text-sm">
                {error}
              </div>
            )}
          </div>
        )
      
      case 'initializing':
        return (
          <div className="flex flex-col items-center justify-center py-12">
            <div className="w-10 h-10 border-2 border-purple-400 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p className="text-sm text-text-secondary font-medium">正在初始化对话...</p>
            <p className="text-xs text-text-secondary mt-1">AI 正在准备角色和场景设置</p>
          </div>
        )
      
      case 'active':
        return (
          <div className="space-y-3 flex flex-col" style={{ height: 'calc(100vh - 160px)' }}>
            {/* 对话区域 - 减少padding和留白 */}
            <div className="flex-1 overflow-y-auto px-2 py-2 bg-gray-50 rounded-card min-h-0">
              {messages.length === 0 ? (
                <div className="flex items-center justify-center h-full text-text-secondary text-sm">
                  等待对话开始...
                </div>
              ) : (
                <>
                  {messages.map((message, index) => (
                    <div
                      key={index}
                      className={`flex ${message.role === 'assistant' ? 'justify-start' : 'justify-end'} mb-3`}
                    >
                      <div className={`max-w-[85%] px-3 py-2 rounded-card text-sm ${message.role === 'assistant' ? 'bg-blue-50 text-blue-800' : 'bg-green-50 text-green-800'}`}>
                        <p className="leading-relaxed">{message.content}</p>
                        {message.audioUrl && (
                          <button
                            className="mt-1.5 text-xs flex items-center text-primary hover:text-primary-dark"
                            onClick={() => playAudio(message.audioUrl!, index)}
                          >
                            <i className={`fas ${playingMessageIndex === index ? 'fa-pause' : 'fa-play'} mr-1.5 text-xs`}></i>
                            {playingMessageIndex === index ? '暂停' : '播放'}
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                  <div ref={messagesEndRef} />
                </>
              )}

              {/* AI 正在输入的加载动画 */}
              {isGeneratingResponse && (
                <div className="flex justify-start mb-3">
                  <div className="max-w-[85%] px-3 py-2 rounded-card bg-blue-50 text-blue-800">
                    <div className="flex items-center space-x-1.5">
                      <div className="animate-bounce">
                        <div className="w-1.5 h-1.5 bg-blue-400 rounded-full"></div>
                      </div>
                      <div className="animate-bounce" style={{ animationDelay: '0.1s' }}>
                        <div className="w-1.5 h-1.5 bg-blue-400 rounded-full"></div>
                      </div>
                      <div className="animate-bounce" style={{ animationDelay: '0.2s' }}>
                        <div className="w-1.5 h-1.5 bg-blue-400 rounded-full"></div>
                      </div>
                      <span className="text-xs text-blue-600 ml-1">AI 正在输入...</span>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* 状态信息 */}
            <div className="text-center text-sm text-text-secondary">
              第 {currentRound} / {maxRounds} 轮
            </div>

            {/* 输入区域 */}
            {showTextInput ? (
              <div className="flex items-center space-x-2">
                <input
                  type="text"
                  value={textInput}
                  onChange={(e) => setTextInput(e.target.value)}
                  placeholder="请输入英文回复..."
                  className="flex-1 py-3 px-4 rounded-card border border-border-light focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 bg-gray-50 text-sm"
                  disabled={isGeneratingResponse}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && textInput.trim()) {
                      handleVoiceInput(textInput.trim())
                      setTextInput('')
                      setShowTextInput(false)
                    }
                  }}
                />
                <button
                  className="px-4 py-3 bg-primary text-white rounded-card hover:shadow-card-hover transition-all disabled:bg-gray-300 disabled:shadow-none text-sm"
                  onClick={() => {
                    if (textInput.trim()) {
                      handleVoiceInput(textInput.trim())
                      setTextInput('')
                      setShowTextInput(false)
                    }
                  }}
                  disabled={isGeneratingResponse || !textInput.trim()}
                >
                  <i className="fas fa-paper-plane"></i>
                </button>
                <button
                  className="px-4 py-3 bg-gray-100 text-text-primary rounded-card hover:bg-gray-200 transition-all disabled:bg-gray-100 text-sm"
                  onClick={() => setShowTextInput(false)}
                  disabled={isGeneratingResponse}
                >
                  <i className="fas fa-microphone"></i>
                </button>
              </div>
            ) : (
              <div className="flex items-center space-x-2">
                <button
                  className={`flex-1 py-3 rounded-card font-semibold text-sm transition-all shadow-card ${isRecording
                    ? 'bg-danger text-white animate-pulse'
                    : isGeneratingResponse
                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed shadow-none'
                    : 'bg-primary text-white hover:shadow-card-hover'}`}
                  onClick={isRecording ? stopRecording : startRecording}
                  disabled={isGeneratingResponse}
                >
                  <div className="flex items-center justify-center">
                    <i className={`fas ${isRecording ? 'fa-stop' : isGeneratingResponse ? 'fa-spinner fa-spin' : 'fa-microphone'} mr-2`}></i>
                    {isRecording ? '停止录音' : isGeneratingResponse ? 'AI 思考中...' : '开始录音'}
                  </div>
                </button>

                {/* 文本输入备用 */}
                <button
                  className="px-4 py-3 bg-gray-100 text-text-primary rounded-card hover:bg-gray-200 transition-all disabled:bg-gray-100 text-sm"
                  onClick={() => setShowTextInput(true)}
                  disabled={isGeneratingResponse}
                >
                  <i className="fas fa-keyboard"></i>
                </button>
              </div>
            )}

            {error && (
              <div className="text-center text-danger text-sm">
                {error}
              </div>
            )}
          </div>
        )
      
      case 'analyzing':
        return (
          <div className="flex flex-col items-center justify-center py-12">
            <div className="w-10 h-10 border-2 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p className="text-sm text-text-secondary font-medium">正在分析您的表现...</p>
            <p className="text-xs text-text-secondary mt-1">AI 正在评估您的语法、词汇、发音等多个维度</p>
          </div>
        )
      
      case 'completed':
        return (
          <AnimatePresence mode="wait">
            {showAnalysis ? (
              <motion.div
                key="analysis"
                initial={{ opacity: 0, x: 50 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -50 }}
                transition={{ duration: 0.4, ease: "easeInOut" }}
              >
                <TestAnalysis 
                  sceneId={sceneId}
                  testId={testId}
                  conversation={messages}
                  rounds={currentRound}
                  onComplete={onComplete}
                />
              </motion.div>
            ) : (
              <motion.div 
                key="completion"
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.9 }}
                transition={{ duration: 0.4 }}
                className="flex flex-col items-center justify-center min-h-[60vh] px-4"
              >
                {/* 成功动画圆圈 */}
                <motion.div 
                  className="relative w-28 h-28"
                  initial={{ scale: 0 }}
                  animate={{ scale: 1 }}
                  transition={{ type: "spring", stiffness: 200, damping: 15 }}
                >
                  {/* 背景圆 */}
                  <motion.div 
                    className="absolute inset-0 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500"
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    transition={{ delay: 0.1, type: "spring", stiffness: 200 }}
                  />
                  {/* 内圈 */}
                  <motion.div 
                    className="absolute inset-2 rounded-full bg-white flex items-center justify-center"
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    transition={{ delay: 0.2, type: "spring", stiffness: 200 }}
                  >
                    <motion.svg 
                      className="w-12 h-12 text-emerald-500"
                      fill="none" 
                      stroke="currentColor" 
                      viewBox="0 0 24 24"
                      initial={{ pathLength: 0, opacity: 0 }}
                      animate={{ pathLength: 1, opacity: 1 }}
                      transition={{ delay: 0.4, duration: 0.5 }}
                    >
                      <motion.path 
                        strokeLinecap="round" 
                        strokeLinejoin="round" 
                        strokeWidth={3} 
                        d="M5 13l4 4L19 7"
                        initial={{ pathLength: 0 }}
                        animate={{ pathLength: 1 }}
                        transition={{ delay: 0.4, duration: 0.5 }}
                      />
                    </motion.svg>
                  </motion.div>
                  {/* 装饰圆点 */}
                  {[...Array(6)].map((_, i) => (
                    <motion.div
                      key={i}
                      className="absolute w-2 h-2 rounded-full bg-emerald-400"
                      style={{
                        top: '50%',
                        left: '50%',
                      }}
                      initial={{ 
                        x: '-50%', 
                        y: '-50%',
                        scale: 0 
                      }}
                      animate={{ 
                        x: `calc(-50% + ${Math.cos(i * 60 * Math.PI / 180) * 60}px)`,
                        y: `calc(-50% + ${Math.sin(i * 60 * Math.PI / 180) * 60}px)`,
                        scale: [0, 1, 0],
                      }}
                      transition={{ 
                        delay: 0.5 + i * 0.1,
                        duration: 0.6,
                        repeat: Infinity,
                        repeatDelay: 2,
                      }}
                    />
                  ))}
                </motion.div>

                <motion.h3 
                  className="mt-8 text-2xl font-bold text-slate-800"
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.3 }}
                >
                  测试完成！
                </motion.h3>
                
                <motion.p 
                  className="mt-3 text-slate-500 text-center max-w-xs"
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.4 }}
                >
                  您已完成 {currentRound} 轮对话，点击下方按钮查看详细分析报告
                </motion.p>

                <motion.button 
                  className="mt-8 px-10 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl font-semibold shadow-lg shadow-blue-500/25 hover:shadow-xl hover:shadow-blue-500/30 transition-all active:scale-95 flex items-center gap-2"
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.5 }}
                  whileHover={{ scale: 1.02 }}
                  whileTap={{ scale: 0.98 }}
                  onClick={() => setShowAnalysis(true)}
                >
                  <span>查看分析报告</span>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </motion.button>
              </motion.div>
            )}
          </AnimatePresence>
        )
      
      default:
        return null
    }
  }

  return (
    <div className="w-full">
      {/* 主要内容 - 导航栏已在 page.tsx 中统一处理 */}
      <main className="mx-4 mt-4">
        {renderContent()}
      </main>
    </div>
  )
}
