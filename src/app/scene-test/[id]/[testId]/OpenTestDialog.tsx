'use client'

import { useState, useEffect, useRef } from 'react'
import Link from 'next/link'
import TestAnalysis from './TestAnalysis'

// 定义消息类型
interface Message {
  role: 'assistant' | 'user'
  content: string
  audioUrl?: string
  timestamp: number
}

// 定义测试状态类型
type TestStatus = 'idle' | 'analyzing' | 'role-selection' | 'initializing' | 'active' | 'analyzing' | 'completed'

// 定义题目分析结果类型
interface QuestionAnalysis {
  scene: string
  roles: string[]
  dialogueGoal: string
}

interface OpenTestDialogProps {
  sceneId: string
  testId: string
  testQuestion: string
  onComplete: () => void
}

export default function OpenTestDialog({ sceneId, testId, testQuestion, onComplete }: OpenTestDialogProps) {
  // 状态管理
  const [status, setStatus] = useState<TestStatus>('idle')
  const [messages, setMessages] = useState<Message[]>([])
  const [currentRound, setCurrentRound] = useState(0)
  const [maxRounds] = useState(3)
  const [isRecording, setIsRecording] = useState(false)
  const [isPlaying, setIsPlaying] = useState(false)
  const [recognition, setRecognition] = useState<any>(null)
  const [audioElement, setAudioElement] = useState<HTMLAudioElement | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string>('')
  const [showAnalysis, setShowAnalysis] = useState(false)

  // 新增状态
  const [questionAnalysis, setQuestionAnalysis] = useState<QuestionAnalysis | null>(null)
  const [selectedRole, setSelectedRole] = useState<string>('')
  const [difficultyLevel, setDifficultyLevel] = useState<string>('Intermediate')

  // 文本输入状态
  const [showTextInput, setShowTextInput] = useState(false)
  const [textInput, setTextInput] = useState('')

  const messagesEndRef = useRef<HTMLDivElement>(null)

  // 初始化语音识别
  useEffect(() => {
    if ('webkitSpeechRecognition' in window) {
      const SpeechRecognition = (window as any).webkitSpeechRecognition
      const recognition = new SpeechRecognition()
      recognition.continuous = false
      recognition.interimResults = false
      recognition.lang = 'en-US'
      
      recognition.onresult = (event: any) => {
        const transcript = event.results[0][0].transcript
        handleVoiceInput(transcript)
      }
      
      recognition.onerror = (event: any) => {
        console.error('语音识别错误:', event.error)
        setError('语音识别失败，请重试')
        setIsRecording(false)
      }
      
      recognition.onend = () => {
        setIsRecording(false)
      }
      
      setRecognition(recognition)
    }
  }, [])

  // 滚动到最新消息
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  // 分析测试题目
  const analyzeQuestion = async () => {
    setStatus('analyzing')
    setError('')
    
    try {
      console.log('开始分析测试题目:', testQuestion)
      
      // 构建题目分析请求
      const analysisRequest = {
        topic: testQuestion
      }
      
      console.log('题目分析请求:', JSON.stringify(analysisRequest, null, 2))
      
      // 调用API分析题目
      const response = await fetch('/api/open-test/analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(analysisRequest),
      })
      
      const data = await response.json()
      console.log('题目分析响应:', JSON.stringify(data, null, 2))
      
      if (!response.ok) {
        throw new Error(data.error || '题目分析失败')
      }
      
      // 解析分析结果
      const analysisResult: QuestionAnalysis = {
        scene: data.scene || 'General',
        roles: data.roles || ['User', 'Assistant'],
        dialogueGoal: data.dialogueGoal || 'Practice English conversation'
      }
      
      console.log('解析的题目分析结果:', analysisResult)
      
      setQuestionAnalysis(analysisResult)
      setStatus('role-selection')
    } catch (err) {
      console.error('题目分析失败:', err)
      const errorMessage = err instanceof Error ? err.message : '题目分析失败，请重试'
      setError(errorMessage)
      setStatus('idle')
    }
  }

  // 初始化测试
  const startTest = async () => {
    // 首先分析题目
    await analyzeQuestion()
  }

  // 确认角色和难度等级，开始对话
  const confirmRoleAndDifficulty = async () => {
    if (!selectedRole) {
      setError('请选择一个角色')
      return
    }
    
    setStatus('initializing')
    setError('')
    
    try {
      console.log('确认角色和难度等级:', {
        selectedRole,
        difficultyLevel,
        questionAnalysis
      })
      
      // 构建初始化请求，包含场景、角色和难度等级信息
      const initRequest = {
        sceneId,
        testId,
        scene: questionAnalysis?.scene,
        aiRole: selectedRole === questionAnalysis?.roles[0] ? questionAnalysis?.roles[1] : questionAnalysis?.roles[0],
        userRole: selectedRole,
        dialogueGoal: questionAnalysis?.dialogueGoal,
        difficultyLevel
      }
      
      console.log('初始化对话请求:', JSON.stringify(initRequest, null, 2))
      
      // 调用API生成初始对话
      const response = await fetch('/api/open-test/initiate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(initRequest),
      })
      
      const data = await response.json()
      console.log('初始化对话响应:', JSON.stringify(data, null, 2))
      
      if (!response.ok) {
        throw new Error(data.error || '初始化对话失败')
      }
      
      // 构建初始消息
      const initialMessage: Message = {
        role: 'assistant',
        content: data.message,
        audioUrl: data.audioUrl,
        timestamp: Date.now(),
      }
      
      console.log('生成的初始消息:', initialMessage)
      
      // 构建对话历史，只包含AI的初始回复
      const completeHistory: Message[] = [initialMessage]
      
      console.log('初始化对话历史:', completeHistory)
      
      setMessages(completeHistory)
      setCurrentRound(1)
      setStatus('active')
    } catch (err) {
      console.error('初始化对话失败:', err)
      const errorMessage = err instanceof Error ? err.message : '初始化对话失败，请重试'
      setError(errorMessage)
      setStatus('role-selection')
    }
  }

  // 生成助手消息（继续对话）
  const generateAssistantMessage = async (prompt: string, conversationHistory: Message[], round: number): Promise<{ message: Message; isEnd: boolean }> => {
    setLoading(true)
    
    try {
      console.log('=== 开始生成助手消息（继续对话）===')
      console.log('用户输入:', prompt)
      console.log('完整对话历史:', conversationHistory)
      console.log('当前轮数:', round)
      console.log('questionAnalysis:', questionAnalysis)
      console.log('selectedRole:', selectedRole)
      
      // 构建完整的对话历史，包含所有角色信息
      const updatedHistory = conversationHistory.map(msg => ({
        role: msg.role,
        content: msg.content
      }))
      
      // 构建完整的API请求，包含场景、角色和难度等级信息
      const apiRequest = {
        sceneId,
        testId,
        conversation: updatedHistory, // 传递完整的对话历史
        round,
        maxRounds,
        scene: questionAnalysis?.scene || '餐厅',
        aiRole: selectedRole === questionAnalysis?.roles[0] ? questionAnalysis?.roles[1] : questionAnalysis?.roles[0] || '服务员',
        userRole: selectedRole || '顾客',
        dialogueGoal: questionAnalysis?.dialogueGoal || '顾客点餐',
        difficultyLevel
      }
      
      console.log('API 请求参数:', JSON.stringify(apiRequest, null, 2))
      
      const response = await fetch('/api/open-test/continue', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(apiRequest),
      })
      
      const data = await response.json()
      console.log('API 响应状态:', response.status)
      console.log('API 响应数据:', JSON.stringify(data, null, 2))
      
      if (!response.ok) {
        // 处理后端返回的错误
        console.error('大模型 API 调用失败:', data)
        throw new Error(data.error || '大模型 API 调用失败')
      }
      
      const assistantMessage = {
        role: 'assistant' as const,
        content: data.message,
        audioUrl: data.audioUrl,
        timestamp: Date.now(),
      }
      
      console.log('生成的助手消息:', assistantMessage)
      console.log('是否结束对话:', data.isEnd || false)
      
      return {
        message: assistantMessage,
        isEnd: data.isEnd || false
      }
    } catch (err) {
      console.error('生成助手消息失败:', err)
      // 抛出错误，让调用者处理
      throw err
    } finally {
      setLoading(false)
      console.log('=== 生成助手消息完成 ===')
    }
  }

  // 处理语音输入
  const handleVoiceInput = async (transcript: string) => {
    if (!transcript.trim()) return
    
    console.log('=== 开始处理语音输入 ===')
    console.log('当前消息状态:', messages)
    console.log('用户输入:', transcript)
    console.log('当前轮数:', currentRound)
    
    // 添加用户消息
    const userMessage: Message = {
      role: 'user',
      content: transcript,
      timestamp: Date.now(),
    }
    
    // 创建包含用户消息的新对话历史
    const updatedMessages = [...messages, userMessage]
    console.log('添加用户消息后的对话历史:', updatedMessages)
    
    // 暂时不更新状态，等到获取助手回复后一起更新
    setLoading(true)
    
    try {
      // 生成助手回应，传递完整的对话历史和下一轮轮数
      console.log('调用generateAssistantMessage，使用完整对话历史')
      const nextRound = currentRound + 1
      console.log('传递的轮数:', nextRound)
      const { message: assistantMessage, isEnd } = await generateAssistantMessage(transcript, updatedMessages, nextRound)
      console.log('收到助手消息:', assistantMessage)
      
      // 构建包含用户消息和助手消息的完整对话历史
      const completeHistory = [...updatedMessages, assistantMessage]
      console.log('添加助手消息后的完整对话历史:', completeHistory)
      
      // 更新消息状态
      setMessages(completeHistory)
      
      // 增加轮数
      console.log('更新轮数:', nextRound)
      setCurrentRound(nextRound)
      
      // 检查是否结束对话
      if (isEnd || nextRound >= maxRounds) {
        console.log('对话结束，开始分析测试结果')
        // 结束测试
        await endTest()
      }
    } catch (err) {
      console.error('处理语音输入失败:', err)
      const errorMessage = err instanceof Error ? err.message : '处理输入失败，请重试'
      setError(errorMessage)
    } finally {
      setLoading(false)
      console.log('=== 语音输入处理完成 ===')
    }
  }

  // 开始录音
  const startRecording = () => {
    if (recognition && !isRecording && !loading) {
      try {
        setIsRecording(true)
        setError('')
        recognition.start()
        
        // 设置30秒的最大录音时间限制
        setTimeout(() => {
          if (isRecording) {
            stopRecording()
          }
        }, 30000)
      } catch (err) {
        console.error('启动录音失败:', err)
        setError('启动录音失败，请重试')
        setIsRecording(false)
      }
    }
  }

  // 停止录音
  const stopRecording = () => {
    if (recognition && isRecording) {
      try {
        recognition.stop()
        setIsRecording(false)
      } catch (err) {
        console.error('停止录音失败:', err)
        setIsRecording(false)
      }
    }
  }

  // 播放语音
  const playAudio = (audioUrl: string) => {
    if (audioElement) {
      audioElement.pause()
    }
    
    const audio = new Audio(audioUrl)
    setAudioElement(audio)
    setIsPlaying(true)
    
    audio.play()
    
    audio.onended = () => {
      setIsPlaying(false)
    }
    
    audio.onerror = () => {
      setIsPlaying(false)
      setError('语音播放失败')
    }
  }

  // 结束测试
  const endTest = async () => {
    setStatus('analyzing')
    setLoading(true)
    
    try {
      console.log('开始分析测试结果...')
      console.log('对话历史:', messages)
      
      // 调用测试分析 API
    const analysisResponse = await fetch('/api/open-test/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        sceneId,
        testId,
        conversation: messages,
        rounds: currentRound
      })
    })
      
      if (!analysisResponse.ok) {
        const errorData = await analysisResponse.json()
        console.error('测试分析 API 调用失败:', errorData)
        throw new Error(errorData.error || '测试分析 API 调用失败')
      }
      
      const analysisData = await analysisResponse.json()
      console.log('测试分析结果:', analysisData)
      
      setStatus('completed')
      // 显示测试分析
      setShowAnalysis(true)
    } catch (err) {
      console.error('结束测试失败:', err)
      const errorMessage = err instanceof Error ? err.message : '结束测试失败，请重试'
      setError(errorMessage)
      setStatus('active')
    } finally {
      setLoading(false)
    }
  }

  // 渲染消息气泡
  const renderMessage = (message: Message, index: number) => {
    return (
      <div 
        key={index} 
        className={`flex ${message.role === 'assistant' ? 'justify-start' : 'justify-end'} mb-4`}
      >
        <div className={`max-w-[80%] p-4 rounded-lg ${message.role === 'assistant' ? 'bg-blue-50 text-blue-800' : 'bg-green-50 text-green-800'}`}>
          <p className="text-sm">{message.content}</p>
          {message.audioUrl && (
            <button 
              className="mt-2 text-xs flex items-center text-primary"
              onClick={() => playAudio(message.audioUrl!)}
            >
              <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'} mr-1`}></i>
              播放语音
            </button>
          )}
        </div>
      </div>
    )
  }

  // 渲染不同状态的界面
  const renderContent = () => {
    switch (status) {
      case 'idle':
        const hasSpeechSupport = 'webkitSpeechRecognition' in window
        return (
          <div className="text-center py-12">
            <h3 className="text-xl font-semibold text-text-primary mb-4">开放题测试</h3>
            <p className="text-text-secondary mb-8">{testQuestion}</p>
            <p className="text-sm text-text-secondary mb-8">
              您将与AI进行3轮对话，通过语音回答问题
            </p>
            {!hasSpeechSupport && (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-8">
                <p className="text-sm text-yellow-700">
                  <i className="fas fa-exclamation-triangle mr-2"></i>
                  您的浏览器不支持语音识别功能，请使用支持的浏览器（如Chrome）
                </p>
              </div>
            )}
            <button 
              className={`px-8 py-3 rounded-lg font-medium ${hasSpeechSupport 
                ? 'bg-primary text-white' 
                : 'bg-gray-400 text-white cursor-not-allowed'}`}
              onClick={startTest}
              disabled={!hasSpeechSupport}
            >
              开始测试
            </button>
          </div>
        )
      
      case 'analyzing':
        return (
          <div className="flex items-center justify-center h-64">
            <div className="text-text-primary">分析测试题目中...</div>
          </div>
        )
      
      case 'role-selection':
        return (
          <div className="py-8 px-4">
            <h3 className="text-xl font-semibold text-text-primary mb-6 text-center">题目分析结果</h3>
            
            {/* 题目分析结果 */}
            <div className="bg-gray-50 rounded-lg p-6 mb-8">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-white p-4 rounded-lg shadow-sm">
                  <h4 className="text-sm font-medium text-gray-500 mb-2">场景</h4>
                  <p className="text-text-primary">{questionAnalysis?.scene || '一般场景'}</p>
                </div>
                <div className="bg-white p-4 rounded-lg shadow-sm">
                  <h4 className="text-sm font-medium text-gray-500 mb-2">角色</h4>
                  <p className="text-text-primary">{questionAnalysis?.roles.join(' / ') || '用户 / 助手'}</p>
                </div>
                <div className="bg-white p-4 rounded-lg shadow-sm">
                  <h4 className="text-sm font-medium text-gray-500 mb-2">对话目标</h4>
                  <p className="text-text-primary">{questionAnalysis?.dialogueGoal || '练习英语对话'}</p>
                </div>
              </div>
            </div>
            
            {/* 角色选择 */}
            <div className="mb-8">
              <h4 className="text-lg font-medium text-text-primary mb-4">选择角色</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {(questionAnalysis?.roles || ['用户', '助手']).map((role, index) => (
                  <button
                    key={index}
                    className={`p-4 rounded-lg border ${selectedRole === role 
                      ? 'border-primary bg-primary/5 text-primary' 
                      : 'border-gray-200 bg-white'}`}
                    onClick={() => setSelectedRole(role)}
                  >
                    <h5 className="font-medium">{role}</h5>
                    <p className="text-sm text-gray-500">
                      {selectedRole === role ? '已选择' : '点击选择'}
                    </p>
                  </button>
                ))}
              </div>
            </div>
            
            {/* 难度等级选择 */}
            <div className="mb-8">
              <h4 className="text-lg font-medium text-text-primary mb-4">选择难度等级</h4>
              <div className="grid grid-cols-3 gap-4">
                {[
                  { value: 'Beginner', label: '初级' },
                  { value: 'Intermediate', label: '中级' },
                  { value: 'Advanced', label: '高级' }
                ].map((level) => (
                  <button
                    key={level.value}
                    className={`p-3 rounded-lg border ${difficultyLevel === level.value 
                      ? 'border-primary bg-primary/5 text-primary' 
                      : 'border-gray-200 bg-white'}`}
                    onClick={() => setDifficultyLevel(level.value)}
                  >
                    {level.label}
                  </button>
                ))}
              </div>
            </div>
            
            {/* 开始对话按钮 */}
            <div className="text-center">
              <button
                className="px-8 py-3 bg-primary text-white rounded-lg font-medium"
                onClick={confirmRoleAndDifficulty}
              >
                开始对话
              </button>
            </div>
            
            {error && (
              <div className="mt-4 text-center text-red-500 text-sm">
                {error}
              </div>
            )}
          </div>
        )
      
      case 'initializing':
        return (
          <div className="flex items-center justify-center h-64">
            <div className="text-text-primary">初始化对话中...</div>
          </div>
        )
      
      case 'active':
        return (
          <div className="space-y-4 flex flex-col" style={{ height: 'calc(100vh - 180px)' }}>
            {/* 对话区域 */}
            <div className="flex-1 overflow-y-auto p-4 bg-gray-50 rounded-lg min-h-0">
              {messages.length === 0 ? (
                <div className="flex items-center justify-center h-full text-text-secondary">
                  等待对话开始...
                </div>
              ) : (
                <>
                  {messages.map((message, index) => (
                    <div
                      key={index}
                      className={`flex ${message.role === 'assistant' ? 'justify-start' : 'justify-end'} mb-4`}
                    >
                      <div className={`max-w-[80%] p-4 rounded-lg ${message.role === 'assistant' ? 'bg-blue-50 text-blue-800' : 'bg-green-50 text-green-800'}`}>
                        <p className="text-sm">{message.content}</p>
                        {message.audioUrl && (
                          <button
                            className="mt-2 text-xs flex items-center text-primary"
                            onClick={() => playAudio(message.audioUrl!)}
                          >
                            <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'} mr-1`}></i>
                            播放语音
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                  <div ref={messagesEndRef} />
                </>
              )}

              {loading && (
                <div className="flex justify-start mb-4">
                  <div className="max-w-[80%] p-4 rounded-lg bg-blue-50 text-blue-800">
                    <div className="animate-pulse">
                      <div className="h-2 bg-blue-200 rounded-full w-3/4 mb-2"></div>
                      <div className="h-2 bg-blue-200 rounded-full w-1/2"></div>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            {/* 状态信息 */}
            <div className="text-center text-sm text-text-secondary">
              第 {currentRound} / {maxRounds} 轮
            </div>
            
            {/* 输入区域 */}
            {showTextInput ? (
              <div className="flex items-center space-x-2">
                <input
                  type="text"
                  value={textInput}
                  onChange={(e) => setTextInput(e.target.value)}
                  placeholder="请输入英文回复..."
                  className="flex-1 py-3 px-4 rounded-lg border border-gray-300 focus:outline-none focus:border-primary"
                  disabled={loading}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && textInput.trim()) {
                      handleVoiceInput(textInput.trim())
                      setTextInput('')
                      setShowTextInput(false)
                    }
                  }}
                />
                <button
                  className="px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors disabled:bg-gray-400"
                  onClick={() => {
                    if (textInput.trim()) {
                      handleVoiceInput(textInput.trim())
                      setTextInput('')
                      setShowTextInput(false)
                    }
                  }}
                  disabled={loading || !textInput.trim()}
                >
                  <i className="fas fa-paper-plane"></i>
                </button>
                <button
                  className="px-4 py-3 bg-gray-200 text-text-primary rounded-lg hover:bg-gray-300 transition-colors"
                  onClick={() => setShowTextInput(false)}
                >
                  <i className="fas fa-microphone"></i>
                </button>
              </div>
            ) : (
              <div className="flex items-center space-x-2">
                <button
                  className={`flex-1 py-3 rounded-lg font-medium transition-all ${isRecording
                    ? 'bg-red-500 text-white animate-pulse'
                    : loading
                    ? 'bg-gray-400 text-white cursor-not-allowed'
                    : 'bg-primary text-white hover:bg-primary/90'}`}
                  onClick={isRecording ? stopRecording : startRecording}
                  disabled={loading}
                >
                  <div className="flex items-center justify-center">
                    <i className={`fas ${isRecording ? 'fa-stop' : loading ? 'fa-spinner fa-spin' : 'fa-microphone'} mr-2`}></i>
                    {isRecording ? '停止录音' : loading ? '处理中...' : '开始录音'}
                  </div>
                </button>

                {/* 文本输入备用 */}
                <button
                  className="px-4 py-3 bg-gray-200 text-text-primary rounded-lg hover:bg-gray-300 transition-colors"
                  onClick={() => setShowTextInput(true)}
                >
                  <i className="fas fa-keyboard"></i>
                </button>
              </div>
            )}
            
            {error && (
              <div className="text-center text-red-500 text-sm">
                {error}
              </div>
            )}
          </div>
        )
      
      case 'analyzing':
        return (
          <div className="flex items-center justify-center h-64">
            <div className="text-text-primary">分析测试结果中...</div>
          </div>
        )
      
      case 'completed':
        if (showAnalysis) {
          return (
            <TestAnalysis 
              sceneId={sceneId}
              testId={testId}
              conversation={messages}
              rounds={currentRound}
              onComplete={onComplete}
            />
          )
        } else {
          return (
            <div className="text-center py-12">
              <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i className="fas fa-check text-green-500 text-3xl"></i>
              </div>
              <h3 className="text-xl font-semibold text-text-primary mb-4">测试完成！</h3>
              <p className="text-text-secondary mb-8">
                您已完成开放题测试，系统正在生成测试解析
              </p>
              <button 
                className="px-8 py-3 bg-primary text-white rounded-lg font-medium"
                onClick={() => setShowAnalysis(true)}
              >
                查看解析
              </button>
            </div>
          )
        }
      
      default:
        return null
    }
  }

  return (
    <div className="w-full">
      {/* 顶部导航 */}
      <header className="bg-white px-4 py-3 shadow-sm sticky top-0 z-10">
        <div className="flex items-center justify-between">
          <Link 
            href={`/scene-detail/${sceneId}`} 
            className="flex items-center text-text-primary"
          >
            <i className="fas fa-arrow-left mr-2"></i>
            返回
          </Link>
          <h2 className="text-lg font-semibold text-text-primary">开放题测试</h2>
          <button className="text-text-primary">
            <i className="fas fa-question-circle"></i>
          </button>
        </div>
      </header>
      
      {/* 主要内容 */}
      <main className="mx-4 mt-4">
        {renderContent()}
      </main>
    </div>
  )
}
