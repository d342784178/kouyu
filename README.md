# è¯­ä¹ é›† - è‹±è¯­å£è¯­å­¦ä¹ APP

ä¸€ä¸ªä¸“æ³¨äºåœºæ™¯åŒ–è‹±è¯­å£è¯­å­¦ä¹ çš„AIé©±åŠ¨å‹Webåº”ç”¨ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨çœŸå®å¯¹è¯åœºæ™¯ä¸­æŒæ¡å®ç”¨å£è¯­è¡¨è¾¾ã€‚

## ğŸ“± é¡¹ç›®æ¦‚è¿°

è¯­ä¹ é›†æ˜¯ä¸€æ¬¾åŸºäºNext.jså¼€å‘çš„è‹±è¯­å£è¯­å­¦ä¹ åº”ç”¨ï¼Œé‡‡ç”¨åœºæ™¯åŒ–å­¦ä¹ æ–¹å¼ï¼Œç»“åˆAIæŠ€æœ¯æä¾›ä¸ªæ€§åŒ–å¯¹è¯ç»ƒä¹ å’Œç²¾å‡†å‘éŸ³åé¦ˆã€‚åº”ç”¨åŒ…å«ä¸°å¯Œçš„æ—¥å¸¸åœºæ™¯å¯¹è¯ã€é«˜é¢‘çŸ­è¯­åº“å’Œæ™ºèƒ½æµ‹è¯•ç³»ç»Ÿã€‚

### æ ¸å¿ƒåŠŸèƒ½

- **åœºæ™¯å­¦ä¹ **: 5å¤§ç±»åœºæ™¯ï¼ˆæ—¥å¸¸ã€èŒåœºã€ç•™å­¦ã€æ—…è¡Œã€ç¤¾äº¤ï¼‰ï¼Œæ¯ä¸ªåœºæ™¯åŒ…å«å®Œæ•´å¯¹è¯ã€è§£æå’Œé«˜é¢‘å•è¯
- **çŸ­è¯­åº“**: 100+é«˜é¢‘è‹±è¯­çŸ­è¯­ï¼Œè¦†ç›–æ—¥å¸¸é«˜é¢‘åœºæ™¯ï¼Œæ”¯æŒæŒ‰åœºæ™¯ç­›é€‰
- **AIå¯¹è¯ç»ƒä¹ **: ä¸AIè¿›è¡Œå¼€æ”¾å¼å¯¹è¯ç»ƒä¹ ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œå®æ—¶è¯„æµ‹
- **æ™ºèƒ½æµ‹è¯•**: æ”¯æŒé€‰æ‹©é¢˜ã€å¡«ç©ºé¢˜ã€é—®ç­”é¢˜ã€å¼€æ”¾å¼å¯¹è¯ç­‰å¤šç§é¢˜å‹
- **å‘éŸ³è®­ç»ƒ**: æ”¯æŒè¯­éŸ³è¾“å…¥ï¼ŒAIè‡ªåŠ¨è¯„æµ‹å‘éŸ³è´¨é‡
- **éŸ³é¢‘æ’­æ”¾**: æ¯ä¸ªçŸ­è¯­å’Œå¯¹è¯éƒ½é…æœ‰æ ‡å‡†å‘éŸ³éŸ³é¢‘

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Next.js 15 (App Router)
- **è¯­è¨€**: TypeScript
- **æ ·å¼**: Tailwind CSS + shadcn/ui
- **åŠ¨ç”»**: Framer Motion
- **æ•°æ®åº“**: PostgreSQL (Neon) + Drizzle ORM
- **å­˜å‚¨**: è…¾è®¯äº‘ COS (éŸ³é¢‘æ–‡ä»¶)
- **AIèƒ½åŠ›**: GLM-4-Flash (æ™ºè°±AI)
- **éƒ¨ç½²**: Vercel

## ğŸ“ é¡¹ç›®ç»“æ„

```
kouyu/
â”œâ”€â”€ src/                          # æºä»£ç 
â”‚   â”œâ”€â”€ app/                      # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ api/                  # APIè·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ scenes/           # åœºæ™¯ç›¸å…³API
â”‚   â”‚   â”‚   â”œâ”€â”€ phrases/          # çŸ­è¯­ç›¸å…³API
â”‚   â”‚   â”‚   â”œâ”€â”€ open-test/        # å¼€æ”¾å¼æµ‹è¯•API
â”‚   â”‚   â”‚   â””â”€â”€ fill-blank/       # å¡«ç©ºæµ‹è¯•API
â”‚   â”‚   â”œâ”€â”€ scene-list/           # åœºæ™¯åˆ—è¡¨é¡µ
â”‚   â”‚   â”œâ”€â”€ scene-detail/         # åœºæ™¯è¯¦æƒ…é¡µ
â”‚   â”‚   â”œâ”€â”€ scene-test/           # åœºæ™¯æµ‹è¯•é¡µ
â”‚   â”‚   â”œâ”€â”€ phrase-library/       # çŸ­è¯­åº“é¡µé¢
â”‚   â”‚   â””â”€â”€ phrase-detail/        # çŸ­è¯­è¯¦æƒ…é¡µ
â”‚   â”œâ”€â”€ components/               # å…¬å…±ç»„ä»¶
â”‚   â”œâ”€â”€ lib/                      # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ db/                   # æ•°æ®åº“é…ç½®å’Œschema
â”‚   â”‚   â”œâ”€â”€ audioUrl.ts           # éŸ³é¢‘URLæ„å»ºå·¥å…·
â”‚   â”‚   â””â”€â”€ llm.ts                # LLMè°ƒç”¨å°è£…
â”‚   â””â”€â”€ types.ts                  # ç±»å‹å®šä¹‰
â”œâ”€â”€ prepare/                      # æ•°æ®å‡†å¤‡è„šæœ¬
â”‚   â”œâ”€â”€ scene/                    # åœºæ™¯æ•°æ®
â”‚   â”‚   â”œâ”€â”€ data/                 # JSONæ•°æ®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ scripts/              # ç®¡ç†è„šæœ¬
â”‚   â””â”€â”€ phrases/                  # çŸ­è¯­æ•°æ®
â”œâ”€â”€ demands/                      # éœ€æ±‚æ–‡æ¡£
â”‚   â”œâ”€â”€ v1/                       # v1ç‰ˆæœ¬
â”‚   â””â”€â”€ v2/                       # v2ç‰ˆæœ¬ï¼ˆå½“å‰ï¼‰
â””â”€â”€ .trae/                        # Traeé…ç½®
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pnpm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env.local` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“è¿æ¥
DATABASE_URL=postgresql://...

# AI API Keyï¼ˆæ™ºè°±AIï¼‰
GLM_API_KEY=...

# è…¾è®¯äº‘COS
NEXT_PUBLIC_COS_BASE_URL=https://kouyu-scene-1300762139.cos.ap-guangzhou.myqcloud.com
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
```

è®¿é—® http://localhost:3000

## ğŸ“Š æ•°æ®è¯´æ˜

### åœºæ™¯æ•°æ®

| ç±»åˆ« | IDå‰ç¼€ | æ•°é‡ | è¯´æ˜ |
|------|--------|------|------|
| daily | daily_ | 30 | æ—¥å¸¸åœºæ™¯ |
| workplace | workplace_ | 25 | èŒåœºåœºæ™¯ |
| study_abroad | study_abroad_ | 20 | ç•™å­¦åœºæ™¯ |
| travel | travel_ | 15 | æ—…è¡Œåœºæ™¯ |
| social | social_ | 10 | ç¤¾äº¤åœºæ™¯ |

- **å¯¹è¯å†…å®¹**: æ¯ä¸ªåœºæ™¯åŒ…å«3-5è½®å¯¹è¯
- **é«˜é¢‘å•è¯**: æ¯ä¸ªåœºæ™¯æå–æ ¸å¿ƒå•è¯å’ŒçŸ­è¯­
- **éŸ³é¢‘**: æ¯å¥å¯¹è¯å’Œè¯æ±‡éƒ½æœ‰æ ‡å‡†å‘éŸ³éŸ³é¢‘

### çŸ­è¯­æ•°æ®

- **æ€»æ•°**: 100ä¸ªé«˜è´¨é‡çŸ­è¯­
- **åˆ†ç±»**: æŒ‰åœºæ™¯åˆ†ç±»
- **éš¾åº¦**: å…¥é—¨/è¿›é˜¶/ä¸­çº§
- **éŸ³é¢‘**: æ¯ä¸ªçŸ­è¯­é…æœ‰æ ‡å‡†å‘éŸ³

### æ•°æ®åº“è¡¨ç»“æ„

**scenes** - åœºæ™¯è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | text | ä¸»é”® |
| name | text | åœºæ™¯åç§° |
| category | text | åˆ†ç±» |
| description | text | åœºæ™¯æè¿° |
| difficulty | text | éš¾åº¦ |
| duration | integer | å­¦ä¹ æ—¶é•¿ |
| tags | jsonb | å…³é”®è¯æ ‡ç­¾ |
| dialogue | jsonb | å¯¹è¯å†…å®¹ |
| vocabulary | jsonb | é«˜é¢‘è¯æ±‡ |

**phrases** - çŸ­è¯­è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | text | ä¸»é”® |
| english | text | è‹±æ–‡çŸ­è¯­ |
| chinese | text | ä¸­æ–‡ç¿»è¯‘ |
| partOfSpeech | text | è¯æ€§ |
| scene | text | é€‚ç”¨åœºæ™¯ |
| difficulty | text | éš¾åº¦ |
| audioUrl | text | éŸ³é¢‘URL |

**scene_tests** - åœºæ™¯æµ‹è¯•è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | text | ä¸»é”® |
| sceneId | text | å…³è”åœºæ™¯ID |
| type | text | æµ‹è¯•ç±»å‹ |
| order | integer | é¢˜ç›®é¡ºåº |
| content | jsonb | é¢˜ç›®å†…å®¹ |

## ğŸ“ ä¸»è¦é¡µé¢

| é¡µé¢ | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| é¦–é¡µ | `/` | å­¦ä¹ è¿›åº¦ã€æ¨èåœºæ™¯ã€åœºæ™¯åˆ†ç±»å…¥å£ |
| åœºæ™¯åˆ—è¡¨ | `/scene-list` | æµè§ˆæ‰€æœ‰åœºæ™¯åˆ†ç±»å’Œåœºæ™¯ |
| åœºæ™¯è¯¦æƒ… | `/scene-detail/[id]` | åœºæ™¯å¯¹è¯å­¦ä¹ ã€è§£æã€é«˜é¢‘å•è¯ |
| åœºæ™¯æµ‹è¯• | `/scene-test/[id]` | åœºæ™¯æµ‹è¯•é€‰æ‹© |
| åœºæ™¯æµ‹è¯•é¢˜ | `/scene-test/[id]/[testId]` | å…·ä½“æµ‹è¯•é¢˜ç›® |
| çŸ­è¯­åº“ | `/phrase-library` | æµè§ˆæ‰€æœ‰çŸ­è¯­ |
| çŸ­è¯­è¯¦æƒ… | `/phrase-detail` | æŸ¥çœ‹çŸ­è¯­è¯¦æƒ… |

## ğŸ”Š éŸ³é¢‘URLæ ¼å¼

éŸ³é¢‘ä½¿ç”¨ `COS:/` åè®®å‰ç¼€ï¼Œç”± `buildAudioUrl` å‡½æ•°è§£æï¼š

```
COS:/scene/dialogues/{scene_id}_round{n}_speaker{x}.mp3
COS:/scene/vocabulary/{scene_id}_vocab{n}_word.mp3
COS:/phrases/{phrase_id}.mp3
```

## ğŸ§ª ç«¯åˆ°ç«¯æµ‹è¯•

é¡¹ç›®ä½¿ç”¨ Playwright è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œè¦†ç›–åœºæ™¯å­¦ä¹ /æµ‹è¯•çš„å®Œæ•´ç”¨æˆ·æµç¨‹ã€‚

### æµ‹è¯•èŒƒå›´

- **åœºæ™¯åˆ—è¡¨é¡µ**: åˆ†ç±»ç­›é€‰ã€æœç´¢ã€æ— é™æ»šåŠ¨ã€å“åº”å¼å¸ƒå±€
- **åœºæ™¯è¯¦æƒ…é¡µ**: å¯¹è¯å­¦ä¹ ã€é«˜é¢‘è¯æ±‡ã€é¡µé¢å¯¼èˆªã€æ•°æ®ç¼“å­˜
- **åœºæ™¯æµ‹è¯•é¡µ**: é€‰æ‹©é¢˜ã€é—®ç­”é¢˜ã€AIè¯„æµ‹ã€æµ‹è¯•æµç¨‹

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test:e2e

# UIæ¨¡å¼è¿è¡Œï¼ˆå¯è§†åŒ–è°ƒè¯•ï¼‰
pnpm test:e2e:ui

# è°ƒè¯•æ¨¡å¼
pnpm test:e2e:debug

# æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
pnpm test:e2e:report

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npx playwright test tests/e2e/scene-list.spec.ts
npx playwright test tests/e2e/scene-detail.spec.ts
npx playwright test tests/e2e/scene-test.spec.ts
```

### æµ‹è¯•é…ç½®

- **æµ‹è¯•ç›®å½•**: `tests/e2e/`
- **æŠ¥å‘Šè¾“å‡º**: `tests/e2e/report/`
- **æµè§ˆå™¨**: Chromium, Mobile Chrome
- **æµ‹è¯•ç”¨ä¾‹**: 66ä¸ªï¼ˆåœºæ™¯åˆ—è¡¨18ä¸ªã€åœºæ™¯è¯¦æƒ…22ä¸ªã€åœºæ™¯æµ‹è¯•26ä¸ªï¼‰

### æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/e2e/
â”œâ”€â”€ fixtures/
â”‚   â””â”€â”€ test-data.ts          # æµ‹è¯•æ•°æ®å’Œé€‰æ‹©å™¨
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ scene-list.spec.ts    # åœºæ™¯åˆ—è¡¨é¡µæµ‹è¯•
â”‚   â”œâ”€â”€ scene-detail.spec.ts  # åœºæ™¯è¯¦æƒ…é¡µæµ‹è¯•
â”‚   â””â”€â”€ scene-test.spec.ts    # åœºæ™¯æµ‹è¯•é¡µæµ‹è¯•
â””â”€â”€ utils/
    â””â”€â”€ test-helpers.ts       # æµ‹è¯•å·¥å…·å‡½æ•°
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ•°æ®ç®¡ç†å‘½ä»¤

```bash
# åœºæ™¯æ•°æ®ç®¡ç†
npx ts-node prepare/scene/scripts/scene-manager.ts test         # æµ‹è¯•éŸ³é¢‘URL
npx ts-node prepare/scene/scripts/scene-manager.ts update-audio # æ›´æ–°JSONéŸ³é¢‘URL
npx ts-node prepare/scene/scripts/scene-manager.ts reset        # é‡ç½®æ•°æ®åº“
npx ts-node prepare/scene/scripts/scene-manager.ts update-db    # æ›´æ–°æ•°æ®åº“éŸ³é¢‘URL
npx ts-node prepare/scene/scripts/scene-manager.ts verify       # éªŒè¯æ›´æ–°ç»“æœ

# çŸ­è¯­æ•°æ®ç®¡ç†
npx ts-node prepare/phrases/scripts/reinit_database.ts
```

### æ·»åŠ æ–°åœºæ™¯

1. å‡†å¤‡åœºæ™¯JSONæ•°æ®
2. ç”ŸæˆéŸ³é¢‘æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°è…¾è®¯äº‘COS
3. è¿è¡Œ `scene-manager.ts reset` å¯¼å…¥æ•°æ®åº“

## ğŸ“¦ éƒ¨ç½²

é¡¹ç›®å·²é…ç½®Verceléƒ¨ç½²ï¼Œæ¨é€ä»£ç åˆ°GitHubåè‡ªåŠ¨éƒ¨ç½²ï¼š

```bash
vercel --prod
```

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®è§„åˆ™](/.trae/rules/project_rules.md) - å¼€å‘è§„èŒƒ
- [éœ€æ±‚æ–‡æ¡£](/demands/v2/éœ€æ±‚æ–‡æ¡£.md) - äº§å“éœ€æ±‚
- [æŠ€æœ¯è®¾è®¡æ–‡æ¡£](/demands/v2/è®¾è®¡æ–‡æ¡£/æŠ€æœ¯è®¾è®¡æ–‡æ¡£.md) - æŠ€æœ¯æ–¹æ¡ˆ
- [æ•°æ®æ¨¡å‹è®¾è®¡](/demands/v2/è®¾è®¡æ–‡æ¡£/è‹±è¯­å£è¯­åœºæ™¯æ•°æ®æ¨¡å‹è®¾è®¡.md) - æ•°æ®åº“è®¾è®¡

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPRï¼

## ğŸ“„ License

MIT License
