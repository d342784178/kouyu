# 语习集APP - 技术设计文档

## 1. 系统架构

### 1.1 技术栈

| 层级 | 技术 | 说明 |
|-----|------|------|
| 前端框架 | Next.js 14 | React框架，支持App Router、SSR/SSG |
| 开发语言 | TypeScript | 类型安全的JavaScript |
| 样式方案 | Tailwind CSS | 原子化CSS框架 |
| 动画库 | Framer Motion | React动画库 |
| 数据库 | PostgreSQL | 关系型数据库 |
| ORM | Drizzle ORM | TypeScript ORM |
| 存储 | Vercel Blob | 音频文件存储 |
| AI服务 | 大语言模型API | 对话生成、评测分析 |
| 部署平台 | Vercel | 前端部署和Serverless函数 |

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端 (Client)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   首页       │  │   短语库     │  │  场景学习    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   场景测试   │  │  开放式对话  │  │  音频播放    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      API路由 (Next.js API)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ /api/phrases │  │ /api/scenes  │  │/api/open-test│       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │/api/fill-blank│  │  /api/audio  │  │      ...     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  PostgreSQL  │  │ Vercel Blob  │  │  LLM API     │       │
│  │   (数据)     │  │  (音频文件)  │  │  (AI服务)    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 数据模型设计

### 2.1 实体关系图

```
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│   phrases    │       │phraseExamples│       │    scenes    │
│   (短语表)   │◄──────│  (示例表)    │       │  (场景表)    │
└──────────────┘       └──────────────┘       └──────┬───────┘
                                                     │
                              ┌──────────────────────┼──────────────────────┐
                              │                      │                      │
                              ▼                      ▼                      ▼
                       ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
                       │  dialogues   │      │ vocabularies │      │ sceneTests   │
                       │  (对话表)    │      │  (单词表)    │      │  (测试表)    │
                       └──────────────┘      └──────────────┘      └──────────────┘
```

### 2.2 数据表结构

#### 2.2.1 短语表 (phrases)

```typescript
export const phrases = pgTable('phrases', {
  id: text('id').primaryKey(),
  english: text('english').notNull(),        // 英文短语
  chinese: text('chinese').notNull(),        // 中文释义
  partOfSpeech: text('part_of_speech').notNull(), // 词性
  scene: text('scene').notNull(),            // 所属场景分类
  difficulty: text('difficulty').notNull(),  // 难度：入门/进阶/中级
  pronunciationTips: text('pronunciation_tips').notNull(), // 发音提示
  audioUrl: text('audio_url'),               // 音频URL
  createdAt: text('created_at').default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text('updated_at').default(sql`CURRENT_TIMESTAMP`)
})
```

#### 2.2.2 短语示例表 (phraseExamples)

```typescript
export const phraseExamples = pgTable('phrase_examples', {
  id: serial('id').primaryKey(),
  phraseId: text('phrase_id').notNull().references(() => phrases.id),
  title: text('title').notNull(),            // 示例标题
  desc: text('desc').notNull(),              // 示例描述
  english: text('english').notNull(),        // 英文示例
  chinese: text('chinese').notNull(),        // 中文翻译
  usage: text('usage').notNull(),            // 使用说明
  audioUrl: text('audio_url'),               // 音频URL
  createdAt: text('created_at').default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text('updated_at').default(sql`CURRENT_TIMESTAMP`)
})
```

#### 2.2.3 场景表 (scenes)

```typescript
export const scenes = pgTable('scenes', {
  id: text('id').primaryKey(),
  name: text('name').notNull(),              // 场景名称
  category: text('category').notNull(),      // 场景分类
  description: text('description').notNull(), // 场景描述
  difficulty: text('difficulty').notNull(),  // 难度
  duration: integer('duration').default(10), // 学习时长（分钟）
  tags: jsonb('tags'),                       // 关键词标签数组
  dialogue: jsonb('dialogue'),               // 对话内容（JSON）
  vocabulary: jsonb('vocabulary'),           // 高频单词（JSON数组）
  createdAt: text('created_at').default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text('updated_at').default(sql`CURRENT_TIMESTAMP`)
})
```

**dialogue字段JSON结构：**
```json
{
  "full_audio_url": "https://...",
  "duration": 120,
  "rounds": [
    {
      "round_number": 1,
      "content": [
        {
          "index": 1,
          "speaker": "A",
          "speaker_name": "服务员",
          "text": "Hello! Welcome to our restaurant.",
          "translation": "你好！欢迎光临我们的餐厅。",
          "audio_url": "https://...",
          "is_key_qa": false
        }
      ],
      "analysis": {
        "analysis_detail": "服务员主动问候",
        "standard_answer": "Hello! Welcome...",
        "alternative_answers": ["Hi there! ..."],
        "usage_notes": "适用于餐厅接待"
      }
    }
  ]
}
```

**vocabulary字段JSON结构：**
```json
[
  {
    "vocab_id": "vocab_001",
    "type": "word",
    "content": "menu",
    "phonetic": "/ˈmenjuː/",
    "translation": "菜单",
    "example_sentence": "Can I see the menu?",
    "example_translation": "我可以看一下菜单吗？",
    "audio_url": "https://...",
    "round_number": 1
  }
]
```

#### 2.2.4 场景测试表 (sceneTests)

```typescript
export const sceneTests = pgTable('scene_tests', {
  id: text('id').primaryKey(),
  sceneId: text('scene_id').notNull().references(() => scenes.id),
  type: text('type').notNull(),              // 题型：choice/fill_blank/qa/open
  order: integer('order').notNull(),         // 题目顺序
  content: jsonb('content').notNull(),       // 题目内容
  createdAt: text('created_at').default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text('updated_at').default(sql`CURRENT_TIMESTAMP`)
})
```

**content字段JSON结构（选择题）：**
```json
{
  "question": "What would you like to order?",
  "options": ["I'd like a coffee", "I'm fine", "See you later"],
  "answer": "I'd like a coffee"
}
```

**content字段JSON结构（填空题）：**
```json
{
  "question": "请用英语回答：你想要点什么？",
  "answer": "I'd like to order a hamburger"
}
```

---

## 3. API接口设计

### 3.1 短语相关接口

#### GET /api/phrases
获取所有短语列表

**响应：**
```json
[
  {
    "id": "phrase_001",
    "english": "I'd like to order",
    "chinese": "我想要点...",
    "partOfSpeech": "phrase",
    "scene": "餐饮服务",
    "difficulty": "入门",
    "pronunciationTips": "注意连读",
    "audioUrl": "https://..."
  }
]
```

#### GET /api/phrases/[id]
获取短语详情

**响应：**
```json
{
  "id": "phrase_001",
  "english": "I'd like to order",
  "chinese": "我想要点...",
  "examples": [...]
}
```

### 3.2 场景相关接口

#### GET /api/scenes
获取场景列表

**响应：**
```json
[
  {
    "id": "scene_001",
    "name": "餐厅点餐",
    "category": "餐饮服务",
    "description": "学习在餐厅点餐的常用对话",
    "difficulty": "初级",
    "duration": 10
  }
]
```

#### GET /api/scenes/[id]
获取场景详情

**响应：**
```json
{
  "id": "scene_001",
  "name": "餐厅点餐",
  "category": "餐饮服务",
  "dialogue": {...},
  "vocabulary": [...]
}
```

#### GET /api/scenes/[id]/tests
获取场景测试列表

**响应：**
```json
[
  {
    "id": "test_001",
    "sceneId": "scene_001",
    "type": "choice",
    "order": 1,
    "content": {...}
  }
]
```

### 3.3 填空题评测接口

#### POST /api/fill-blank/evaluate
评测填空题答案

**请求：**
```json
{
  "question": "请用英语回答：你想要点什么？",
  "userAnswer": "I'd like a hamburger",
  "standardAnswer": "I'd like to order a hamburger"
}
```

**响应：**
```json
{
  "isCorrect": true,
  "analysis": "用户回答基本正确，表达了想要点餐的意思。使用了正确的句型I'd like...",
  "suggestions": [
    "可以更完整地使用'I'd like to order'",
    "注意在正式场合使用完整的表达"
  ]
}
```

### 3.4 开放式对话接口

#### POST /api/open-test/initiate
初始化开放式对话

**请求：**
```json
{
  "question": "在餐厅点餐",
  "selectedRole": "顾客",
  "difficultyLevel": "Intermediate"
}
```

**响应：**
```json
{
  "analysis": {
    "scene": "餐厅点餐",
    "roles": ["服务员", "顾客"],
    "dialogueGoal": "完成点餐"
  },
  "initialMessage": {
    "role": "assistant",
    "content": "Hello! Welcome to our restaurant...",
    "audioUrl": "https://..."
  }
}
```

#### POST /api/open-test/continue
继续对话

**请求：**
```json
{
  "messages": [...],
  "userMessage": "I'd like a hamburger",
  "currentRound": 2,
  "maxRounds": 3
}
```

**响应：**
```json
{
  "message": {
    "role": "assistant",
    "content": "Great choice! Would you like...",
    "audioUrl": "https://..."
  },
  "currentRound": 2,
  "isCompleted": false
}
```

#### POST /api/open-test/analyze
分析对话表现

**请求：**
```json
{
  "messages": [...],
  "scene": "餐厅点餐",
  "role": "顾客"
}
```

**响应：**
```json
{
  "score": 85,
  "evaluation": "表现良好，语法基本正确...",
  "grammarScore": 90,
  "vocabularyScore": 85,
  "fluencyScore": 80,
  "suggestions": ["建议1", "建议2"]
}
```

---

## 4. 组件设计

### 4.1 组件清单

| 组件名称 | 路径 | 功能描述 |
|---------|------|---------|
| BottomNav | `/components/BottomNav.tsx` | 底部导航栏 |
| SceneCard | `/app/SceneCard.tsx` | 场景卡片 |
| PhraseCard | `/app/PhraseCard.tsx` | 短语卡片 |
| ProgressBar | `/app/scene-test/[id]/[testId]/components/ProgressBar.tsx` | 进度条 |
| QuestionTypeCard | `/app/scene-test/[id]/[testId]/components/QuestionTypeCard.tsx` | 题型标识卡 |
| LoadingSpinner | `/app/scene-test/[id]/[testId]/components/LoadingSpinner.tsx` | 加载动画 |
| DialogueContent | `/app/scene-detail/[id]/components/DialogueContent.tsx` | 对话内容 |
| VocabularyContent | `/app/scene-detail/[id]/components/VocabularyContent.tsx` | 词汇内容 |
| OpenTestDialog | `/app/scene-test/[id]/[testId]/OpenTestDialog.tsx` | 开放式对话弹窗 |

### 4.2 关键组件设计

#### 4.2.1 BottomNav 底部导航

```typescript
interface BottomNavProps {
  activeTab: 'home' | 'phrases' | 'scenes' | 'profile'
}

// 功能：
// - 显示4个导航项（首页、短语库、场景学习、我的）
// - 当前页面高亮显示
// - 点击切换页面
```

#### 4.2.2 OpenTestDialog 开放式对话

```typescript
interface OpenTestDialogProps {
  isOpen: boolean
  onClose: () => void
  testQuestion: string
  sceneId: string
}

// 状态管理：
// - 'idle': 初始状态，显示题目和开始按钮
// - 'analyzing': 分析题目中
// - 'role-selection': 选择角色和难度
// - 'initializing': 初始化对话
// - 'active': 对话进行中
// - 'analyzing-result': 分析结果中
// - 'completed': 对话完成，展示结果

// 功能：
// - 语音识别输入
// - AI对话生成
// - 语音合成播放
// - 对话历史记录
// - 结果分析和评分
```

---

## 5. 状态管理

### 5.1 本地状态

使用React useState管理组件本地状态：

```typescript
// 测试页面状态
const [currentTestIndex, setCurrentTestIndex] = useState(0)
const [selectedOption, setSelectedOption] = useState<string | null>(null)
const [isAnswered, setIsAnswered] = useState(false)
const [fillBlankAnswer, setFillBlankAnswer] = useState('')
const [isEvaluating, setIsEvaluating] = useState(false)

// 开放式对话状态
const [status, setStatus] = useState<DialogStatus>('idle')
const [messages, setMessages] = useState<Message[]>([])
const [currentRound, setCurrentRound] = useState(0)
const [isRecording, setIsRecording] = useState(false)
```

### 5.2 音频播放状态

使用自定义Hook管理音频播放：

```typescript
// hooks/useAudio.ts
export function useAudio() {
  const [playingMessageIndex, setPlayingMessageIndex] = useState<number | null>(null)
  const audioRef = useRef<HTMLAudioElement | null>(null)
  
  const playAudio = (audioUrl: string, index: number) => {
    // 播放控制逻辑
  }
  
  const stopAudio = () => {
    // 停止播放逻辑
  }
  
  return { playingMessageIndex, playAudio, stopAudio }
}
```

---

## 6. 语音识别实现

### 6.1 Web Speech API

使用浏览器原生Web Speech API实现语音识别：

```typescript
// 初始化语音识别
const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)()
recognition.lang = 'en-US'  // 设置语言为英语
recognition.continuous = false
recognition.interimResults = false

// 开始录音
recognition.start()

// 处理识别结果
recognition.onresult = (event) => {
  const transcript = event.results[0][0].transcript
  setFillBlankAnswer(transcript)
}

// 错误处理
recognition.onerror = (event) => {
  console.error('语音识别错误:', event.error)
}
```

### 6.2 兼容性处理

```typescript
// 检查浏览器支持
const hasSpeechSupport = 'webkitSpeechRecognition' in window || 
                         'SpeechRecognition' in window

if (!hasSpeechSupport) {
  // 显示不支持提示，提供文本输入备选
}
```

---

## 7. AI服务集成

### 7.1 大语言模型调用

```typescript
// lib/llm.ts
export async function callLLM(messages: Message[]) {
  const response = await fetch('https://api.llm.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${process.env.AI_API_KEY}`
    },
    body: JSON.stringify({
      model: 'gpt-4',
      messages,
      temperature: 0.7
    })
  })
  
  return response.json()
}
```

### 7.2 语音合成

```typescript
// 使用Web Speech API合成语音
const utterance = new SpeechSynthesisUtterance(text)
utterance.lang = 'en-US'
utterance.rate = 1.0
utterance.pitch = 1.0

speechSynthesis.speak(utterance)
```

---

## 8. 性能优化

### 8.1 前端优化

- **组件懒加载**：使用dynamic import懒加载大型组件
- **图片优化**：使用Next.js Image组件优化图片加载
- **音频预加载**：关键音频资源预加载
- **状态优化**：避免不必要的重渲染

### 8.2 后端优化

- **数据库索引**：为常用查询字段添加索引
- **API缓存**：使用Next.js缓存策略
- **音频CDN**：音频文件使用CDN加速
- **AI响应缓存**：缓存常见AI响应

---

## 9. 安全设计

### 9.1 数据安全

- **环境变量**：敏感信息存储在环境变量
- **API密钥**：AI API密钥服务端管理
- **数据库连接**：使用连接池和SSL

### 9.2 接口安全

- **请求限流**：防止API滥用
- **输入验证**：验证所有用户输入
- **CORS配置**：限制跨域请求

---

## 10. 部署配置

### 10.1 Vercel配置

```json
// vercel.json
{
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 30
    }
  }
}
```

### 10.2 环境变量

```bash
# .env.local
DATABASE_URL=postgresql://...
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...
AI_API_KEY=sk-...
```

---

## 11. 附录

### 11.1 目录结构

```
src/
├── app/                          # Next.js App Router
│   ├── api/                      # API路由
│   │   ├── audio/route.ts
│   │   ├── fill-blank/evaluate/route.ts
│   │   ├── open-test/
│   │   │   ├── initiate/route.ts
│   │   │   ├── continue/route.ts
│   │   │   ├── analyze/route.ts
│   │   │   └── speech/route.ts
│   │   ├── phrases/route.ts
│   │   └── scenes/
│   │       ├── route.ts
│   │       └── [id]/
│   │           ├── route.ts
│   │           └── tests/route.ts
│   ├── phrase-library/page.tsx
│   ├── phrase-detail/page.tsx
│   ├── scene-list/page.tsx
│   ├── scene-detail/[id]/
│   │   ├── page.tsx
│   │   └── components/
│   ├── scene-test/[id]/
│   │   ├── page.tsx
│   │   └── [testId]/
│   │       ├── page.tsx
│   │       ├── OpenTestDialog.tsx
│   │       └── components/
│   ├── test/page.tsx
│   ├── layout.tsx
│   ├── page.tsx
│   ├── PhraseCard.tsx
│   └── SceneCard.tsx
├── components/
│   └── BottomNav.tsx
├── hooks/
│   └── useAudio.ts
├── lib/
│   ├── db/
│   │   ├── index.ts
│   │   └── schema.ts
│   └── llm.ts
└── styles/
    └── globals.css
```

### 11.2 更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2026-02-18 | 初始版本，包含完整技术架构和数据模型 |
