# 语习集 APP 技术设计文档

## 1. 项目概述

语习集是一款语言学习应用，旨在帮助用户通过场景化学习提高语言能力。本次设计文档基于用户需求，详细规划了场景学习模块的实现方案，包括模块结构、数据模型、API 接口、页面设计和实现计划。

## 2. 技术栈

### 前端技术
- React Native (0.72.6) - 跨平台移动应用开发
- TypeScript (5.0.0+) - 类型安全的 JavaScript 超集
- Tailwind CSS (3.3.0+) - 实用优先的 CSS 框架
- Redux Toolkit (1.9.5+) - 状态管理
- React Navigation (6.16.0+) - 应用导航
- Expo (49.0.0+) - 开发工具链

### 后端技术
- Node.js (18.0.0+) - JavaScript 运行时
- Express (4.18.0+) - Web 框架
- MongoDB (6.0.0+) - 文档数据库
- Google Cloud Speech-to-Text - 语音识别
- Google Cloud Text-to-Speech - 语音合成
- OpenAI API - 对话生成
- Microsoft Azure Speech Services - 发音评估

## 3. 改动分析

### 3.1 现有功能分析

当前项目已实现的功能：
- 首页：学习进度概览、复习提醒、推荐短语、学习场景分类
- 短语库：短语列表、短语详情
- 底部导航栏：首页、短语库、对话、我的

### 3.2 需要添加的功能

根据用户需求，需要添加以下功能：

1. **场景学习模块**
   - 场景分类列表
   - 场景详情页（对话内容和分析）
   - 场景测试页（每道题目单独一页）

2. **导航调整**
   - 在底部导航栏添加"场景学习"选项
   - 移除"对话"选项

3. **首页调整**
   - 替换"推荐短语"部分为"场景学习"模块
   - 保留短语库模块

4. **数据模型扩展**
   - 添加场景相关的数据表
   - 添加场景对话和测试相关的数据结构

## 4. 实现方案

### 4.1 目录结构调整

```
src/
  app/
    api/
      phrases/        # 现有的短语 API
      scenes/         # 新增的场景 API
        route.ts
        [id]/
          route.ts
          dialogues/
            route.ts
          tests/
            route.ts
    phrase-library/   # 现有的短语库页面
    phrase-detail/    # 现有的短语详情页面
    scene-list/       # 新增的场景列表页面
      page.tsx
      ClientComponent.tsx
    scene-detail/     # 新增的场景详情页面
      [id]/
        page.tsx
        ClientComponent.tsx
    scene-test/       # 新增的场景测试页面
      [id]/
        [testId]/
          page.tsx
          ClientComponent.tsx
    page.tsx          # 首页（需要修改）
  components/
    BottomNav.tsx     # 底部导航栏（需要修改）
    SceneCard.tsx     # 新增的场景卡片组件
    DialogCard.tsx    # 新增的对话卡片组件
  hooks/
    useAudio.ts       # 现有的音频播放 hook
  lib/
    db/
      index.ts
      schema.ts       # 数据模型（需要扩展）
  styles/
    globals.css
```

### 4.2 数据模型设计

#### 4.2.1 场景表 (scenes)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | TEXT | 场景 ID（主键） |
| name | TEXT | 场景名称 |
| category | TEXT | 场景分类 |
| description | TEXT | 场景描述 |
| difficulty | TEXT | 难度级别 |
| createdAt | TIMESTAMP | 创建时间 |
| updatedAt | TIMESTAMP | 更新时间 |

#### 4.2.2 场景对话表 (scene_dialogues)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | TEXT | 对话 ID（主键） |
| sceneId | TEXT | 关联的场景 ID（外键） |
| speaker | TEXT | 说话人 |
| content | TEXT | 对话内容 |
| translation | TEXT | 对话翻译 |
| audioUrl | TEXT | 音频 URL |
| order | INTEGER | 对话顺序 |
| createdAt | TIMESTAMP | 创建时间 |
| updatedAt | TIMESTAMP | 更新时间 |

#### 4.2.3 场景测试表 (scene_tests)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | TEXT | 测试 ID（主键） |
| sceneId | TEXT | 关联的场景 ID（外键） |
| type | TEXT | 测试类型（选择题/填空题/开放题） |
| question | TEXT | 问题内容 |
| options | JSONB | 选项（选择题） |
| answer | TEXT | 正确答案 |
| analysis | TEXT | 答案分析 |
| order | INTEGER | 题目顺序 |
| createdAt | TIMESTAMP | 创建时间 |
| updatedAt | TIMESTAMP | 更新时间 |

### 4.3 API 接口设计

#### 4.3.1 场景列表接口

- **URL**: `/api/scenes`
- **方法**: GET
- **功能**: 获取所有场景列表
- **响应**: 场景列表数据

#### 4.3.2 场景详情接口

- **URL**: `/api/scenes/[id]`
- **方法**: GET
- **功能**: 获取指定场景的详细信息
- **响应**: 场景详情数据

#### 4.3.3 场景对话接口

- **URL**: `/api/scenes/[id]/dialogues`
- **方法**: GET
- **功能**: 获取指定场景的对话内容
- **响应**: 对话列表数据

#### 4.3.4 场景测试接口

- **URL**: `/api/scenes/[id]/tests`
- **方法**: GET
- **功能**: 获取指定场景的测试题目
- **响应**: 测试题目列表数据

### 4.4 页面设计

#### 4.4.1 底部导航栏 (BottomNav.tsx)

修改现有底部导航栏，将"对话"选项替换为"场景学习"选项：

```tsx
<nav id="bottom-nav" className="fixed bottom-0 left-0 right-0 bg-white border-t border-border-light flex justify-around items-center h-16 px-2 safe-bottom z-40">
  <Link 
    id="nav-home" 
    href="/" 
    className={`flex flex-col items-center p-2 ${pathname === '/' ? 'text-primary' : 'text-text-secondary'}`}
  >
    <i className="fas fa-home text-xl"></i>
    <span className="text-xs mt-0.5 font-medium">首页</span>
  </Link>
  <Link 
    id="nav-library" 
    href="/phrase-library" 
    className={`flex flex-col items-center p-2 ${pathname === '/phrase-library' ? 'text-primary' : 'text-text-secondary'}`}
  >
    <i className="fas fa-book text-xl"></i>
    <span className="text-xs mt-0.5">短语库</span>
  </Link>
  <Link 
    id="nav-scene" 
    href="/scene-list" 
    className={`flex flex-col items-center p-2 ${pathname === '/scene-list' ? 'text-primary' : 'text-text-secondary'}`}
  >
    <i className="fas fa-map text-xl"></i>
    <span className="text-xs mt-0.5">场景学习</span>
  </Link>
  <Link 
    id="nav-profile" 
    href="#" 
    className="flex flex-col items-center p-2 text-text-secondary"
  >
    <i className="fas fa-user text-xl"></i>
    <span className="text-xs mt-0.5">我的</span>
  </Link>
</nav>
```

#### 4.4.2 首页 (page.tsx)

修改首页，将"推荐短语"部分替换为"场景学习"模块：

```tsx
// 推荐场景
<section id="recommended-scenes" className="mx-6 mt-6">
  <div id="recommended-header" className="flex items-center justify-between mb-4">
    <h2 id="recommended-title" className="text-lg font-semibold text-text-primary">推荐场景</h2>
    <Link href="/scene-list" id="more-scenes-btn" className="text-primary text-sm font-medium">更多</Link>
  </div>
  
  <div id="scenes-list" className="space-y-3">
    {recommendedScenes.length > 0 ? (
      recommendedScenes.map((scene, index) => (
        <SceneCard key={scene.id} scene={scene} index={index} />
      ))
    ) : (
      <div id="no-scenes" className="text-center py-6">
        <p className="text-text-secondary">暂无推荐场景</p>
      </div>
    )}
  </div>
</section>
```

#### 4.4.3 场景列表页 (scene-list/page.tsx)

创建场景列表页，展示所有场景分类和场景：

```tsx
export default async function SceneList() {
  // 获取场景列表
  const scenes = await getScenes();
  
  // 按分类分组场景
  const scenesByCategory = groupScenesByCategory(scenes);
  
  return (
    <div id="scene-list-content" className="pb-20">
      <header id="scene-list-header" className="bg-white px-6 py-4 shadow-sm">
        <h1 id="scene-list-title" className="text-xl font-bold text-text-primary">场景学习</h1>
      </header>
      
      <main id="scene-list-main" className="mx-6 mt-6">
        {Object.entries(scenesByCategory).map(([category, categoryScenes]) => (
          <section key={category} id={`category-${category}`} className="mb-8">
            <h2 id={`category-${category}-title`} className="text-lg font-semibold text-text-primary mb-4">
              {category}
            </h2>
            
            <div id={`category-${category}-list`} className="space-y-4">
              {categoryScenes.map((scene) => (
                <Link 
                  key={scene.id} 
                  href={`/scene-detail/${scene.id}`} 
                  id={`scene-${scene.id}`} 
                  className="block"
                >
                  <div className="scene-card bg-white rounded-card shadow-card p-4 card-hover">
                    <div className="scene-card-content flex items-center">
                      <div className="scene-card-image w-20 h-20 rounded-lg overflow-hidden mr-4">
                        <img 
                          src={scene.coverImage || 'https://via.placeholder.com/100'} 
                          alt={scene.name} 
                          className="w-full h-full object-cover"
                        />
                      </div>
                      <div className="scene-card-info flex-1">
                        <h3 className="scene-card-title text-base font-semibold text-text-primary mb-1">
                          {scene.name}
                        </h3>
                        <p className="scene-card-description text-xs text-text-secondary mb-2">
                          {scene.description}
                        </p>
                        <div className="scene-card-meta flex items-center justify-between">
                          <span className="scene-card-difficulty text-xs px-2 py-0.5 rounded-full bg-primary-light text-primary">
                            {scene.difficulty}
                          </span>
                          <span className="scene-card-count text-xs text-text-secondary">
                            共 {scene.dialogueCount} 个对话
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </Link>
              ))}
            </div>
          </section>
        ))}
      </main>
    </div>
  );
}
```

#### 4.4.4 场景详情页 (scene-detail/[id]/page.tsx)

创建场景详情页，展示场景对话内容和分析：

```tsx
export default async function SceneDetail({ params }: { params: { id: string } }) {
  const { id } = params;
  // 获取场景详情
  const scene = await getSceneById(id);
  // 获取场景对话
  const dialogues = await getSceneDialogues(id);
  
  return (
    <div id="scene-detail-content" className="pb-20">
      <header id="scene-detail-header" className="bg-white px-6 py-4 shadow-sm sticky top-0 z-30">
        <div id="scene-detail-header-content" className="flex items-center justify-between">
          <button id="back-btn" className="w-8 h-8 flex items-center justify-center">
            <i className="fas fa-arrow-left text-text-primary text-lg"></i>
          </button>
          <h1 id="scene-detail-title" className="text-xl font-bold text-text-primary">{scene.name}</h1>
          <button id="more-btn" className="w-8 h-8 flex items-center justify-center">
            <i className="fas fa-ellipsis-v text-text-primary text-lg"></i>
          </button>
        </div>
      </header>
      
      <main id="scene-detail-main" className="mx-6 mt-6">
        <section id="scene-detail-info" className="mb-6">
          <div id="scene-detail-cover" className="w-full h-40 rounded-card overflow-hidden mb-4">
            <img 
              src={scene.coverImage || 'https://via.placeholder.com/400x200'} 
              alt={scene.name} 
              className="w-full h-full object-cover"
            />
          </div>
          <h2 id="scene-detail-description" className="text-base text-text-secondary mb-4">
            {scene.description}
          </h2>
          <div id="scene-detail-meta" className="flex items-center space-x-4 mb-6">
            <span id="scene-detail-category" className="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-text-secondary">
              {scene.category}
            </span>
            <span id="scene-detail-difficulty" className="text-xs px-2 py-0.5 rounded-full bg-primary-light text-primary">
              {scene.difficulty}
            </span>
          </div>
          <Link 
            href={`/scene-test/${scene.id}`} 
            id="start-test-btn" 
            className="block w-full py-3 bg-gradient-to-r from-primary to-secondary text-white text-center font-medium rounded-card shadow-md"
          >
            开始测试
          </Link>
        </section>
        
        <section id="scene-dialogues" className="mb-6">
          <h2 id="dialogues-title" className="text-lg font-semibold text-text-primary mb-4">对话内容</h2>
          
          <div id="dialogues-list" className="space-y-4">
            {dialogues.map((dialogue, index) => (
              <div key={dialogue.id} id={`dialogue-${dialogue.id}`} className="dialogue-card bg-white rounded-card shadow-card p-4">
                <div id={`dialogue-${dialogue.id}-header`} className="flex items-center justify-between mb-3">
                  <span id={`dialogue-${dialogue.id}-speaker`} className="text-sm font-medium text-text-primary">
                    {dialogue.speaker}
                  </span>
                  <button id={`dialogue-${dialogue.id}-audio-btn`} className="w-8 h-8 rounded-full bg-primary-light flex items-center justify-center">
                    <i className="fas fa-volume-up text-primary"></i>
                  </button>
                </div>
                <p id={`dialogue-${dialogue.id}-content`} className="text-base text-text-primary mb-2">
                  {dialogue.content}
                </p>
                <p id={`dialogue-${dialogue.id}-translation`} className="text-sm text-text-secondary">
                  {dialogue.translation}
                </p>
              </div>
            ))}
          </div>
        </section>
      </main>
    </div>
  );
}
```

#### 4.4.5 场景测试页 (scene-test/[id]/[testId]/page.tsx)

创建场景测试页，每道题目单独一页：

```tsx
export default async function SceneTest({ params }: { params: { id: string; testId: string } }) {
  const { id, testId } = params;
  // 获取场景信息
  const scene = await getSceneById(id);
  // 获取测试题目
  const tests = await getSceneTests(id);
  // 获取当前题目
  const currentTest = tests.find(test => test.id === testId);
  // 获取当前题目索引
  const currentIndex = tests.findIndex(test => test.id === testId);
  
  return (
    <div id="scene-test-content" className="pb-20">
      <header id="scene-test-header" className="bg-white px-6 py-4 shadow-sm sticky top-0 z-30">
        <div id="scene-test-header-content" className="flex items-center justify-between">
          <button id="back-btn" className="w-8 h-8 flex items-center justify-center">
            <i className="fas fa-arrow-left text-text-primary text-lg"></i>
          </button>
          <h1 id="scene-test-title" className="text-xl font-bold text-text-primary">场景测试</h1>
          <div className="w-8"></div> {/* 占位，保持标题居中 */}
        </div>
      </header>
      
      <main id="scene-test-main" className="mx-6 mt-6">
        <section id="test-progress" className="mb-6">
          <div id="progress-bar-container" className="w-full h-2 bg-gray-100 rounded-full mb-2">
            <div 
              id="progress-bar" 
              className="h-full bg-primary rounded-full" 
              style={{ width: `${((currentIndex + 1) / tests.length) * 100}%` }}
            ></div>
          </div>
          <div id="progress-text" className="flex justify-between text-xs text-text-secondary">
            <span>第 {currentIndex + 1} 题</span>
            <span>共 {tests.length} 题</span>
          </div>
        </section>
        
        <section id="test-question" className="mb-8">
          <h2 id="question-text" className="text-lg font-semibold text-text-primary mb-6">
            {currentTest?.question}
          </h2>
          
          {currentTest?.type === 'multiple-choice' && (
            <div id="multiple-choice-options" className="space-y-3">
              {currentTest.options.map((option, index) => (
                <button 
                  key={index} 
                  id={`option-${index}`} 
                  className="w-full py-3 px-4 bg-white rounded-card shadow-sm border border-border-light text-left"
                >
                  <span className="text-base text-text-primary">{option}</span>
                </button>
              ))}
            </div>
          )}
          
          {currentTest?.type === 'fill-blank' && (
            <div id="fill-blank-input">
              <input 
                type="text" 
                id="answer-input" 
                placeholder="请输入答案..." 
                className="w-full py-3 px-4 bg-white rounded-card shadow-sm border border-border-light"
              />
            </div>
          )}
          
          {currentTest?.type === 'open' && (
            <div id="open-answer-input">
              <textarea 
                id="answer-textarea" 
                placeholder="请输入答案..." 
                rows={4} 
                className="w-full py-3 px-4 bg-white rounded-card shadow-sm border border-border-light"
              ></textarea>
            </div>
          )}
        </section>
        
        <section id="test-navigation" className="flex justify-between">
          <button 
            id="prev-btn" 
            className={`py-3 px-6 rounded-card font-medium ${currentIndex === 0 ? 'opacity-50 cursor-not-allowed' : 'bg-white shadow-sm text-text-primary'}`}
            disabled={currentIndex === 0}
          >
            上一题
          </button>
          <button 
            id="next-btn" 
            className={`py-3 px-6 rounded-card font-medium ${currentIndex === tests.length - 1 ? 'bg-gradient-to-r from-primary to-secondary text-white' : 'bg-white shadow-sm text-text-primary'}`}
          >
            {currentIndex === tests.length - 1 ? '提交' : '下一题'}
          </button>
        </section>
      </main>
    </div>
  );
}
```

## 5. 实现计划

### 5.1 阶段一：数据模型和 API 接口

1. 扩展数据模型 (schema.ts)，添加场景相关的表结构
2. 实现场景相关的 API 接口
3. 创建测试数据，确保 API 接口正常工作

### 5.2 阶段二：页面组件开发

1. 修改底部导航栏，添加"场景学习"选项
2. 修改首页，替换"推荐短语"部分为"场景学习"模块
3. 创建场景列表页
4. 创建场景详情页
5. 创建场景测试页

### 5.3 阶段三：功能集成和测试

1. 集成所有页面组件
2. 测试场景学习流程
3. 优化用户体验和性能
4. 修复可能的问题和 bug

## 6. 技术风险和应对策略

### 6.1 技术风险

1. **数据模型复杂性**：场景学习模块涉及多个数据表，关系复杂
2. **API 接口性能**：场景对话和测试数据可能较大，影响加载速度
3. **用户体验一致性**：需要确保新模块与现有模块的设计风格一致

### 6.2 应对策略

1. **数据模型设计**：采用清晰的表结构和关系，使用适当的索引优化查询性能
2. **API 接口优化**：实现数据分页和缓存机制，减少不必要的数据传输
3. **用户体验设计**：参考现有页面的设计风格，确保视觉一致性
4. **测试和调试**：充分测试各个功能模块，确保稳定运行

## 7. 结论

本技术设计文档详细规划了语习集 APP 场景学习模块的实现方案，包括数据模型、API 接口、页面设计和实现计划。通过合理的架构设计和分步实施，可以确保场景学习模块的顺利开发和集成，为用户提供更好的语言学习体验。